<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Lesson 2 Sentiment | Clean Air in the Time of COVID</title>
  <meta name="description" content="These materials are for a 45 minute teaching demonstration oriented towards students in the new Masters in Environmental Data Science at UCSB." />
  <meta name="generator" content="bookdown 0.16 and GitBook 2.6.7" />

  <meta property="og:title" content="Lesson 2 Sentiment | Clean Air in the Time of COVID" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="These materials are for a 45 minute teaching demonstration oriented towards students in the new Masters in Environmental Data Science at UCSB." />
  <meta name="github-repo" content="bbest/meds-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Lesson 2 Sentiment | Clean Air in the Time of COVID" />
  
  <meta name="twitter:description" content="These materials are for a 45 minute teaching demonstration oriented towards students in the new Masters in Environmental Data Science at UCSB." />
  

<meta name="author" content="Ben Best, PhD" />


<meta name="date" content="2020-05-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="satellite.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="style/style.css" type="text/css" />
<link rel="stylesheet" href="style/lesson.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">MEDS demo</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#motivation"><i class="fa fa-check"></i>Motivation</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#technologies"><i class="fa fa-check"></i>Technologies</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#motivating-use-case"><i class="fa fa-check"></i>Motivating Use Case</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i>Setup</a><ul>
<li class="chapter" data-level="0.1" data-path="setup.html"><a href="setup.html#apply-for-accounts"><i class="fa fa-check"></i><b>0.1</b> Apply for accounts</a><ul>
<li class="chapter" data-level="0.1.1" data-path="setup.html"><a href="setup.html#google-earth-engine-gee-account"><i class="fa fa-check"></i><b>0.1.1</b> Google Earth Engine (GEE) account</a></li>
<li class="chapter" data-level="0.1.2" data-path="setup.html"><a href="setup.html#twitter-developer-account"><i class="fa fa-check"></i><b>0.1.2</b> Twitter developer account</a></li>
</ul></li>
<li class="chapter" data-level="0.2" data-path="setup.html"><a href="setup.html#install-software"><i class="fa fa-check"></i><b>0.2</b> Install software</a></li>
<li class="chapter" data-level="0.3" data-path="setup.html"><a href="setup.html#launch-rstudio"><i class="fa fa-check"></i><b>0.3</b> Launch RStudio</a></li>
<li class="chapter" data-level="0.4" data-path="setup.html"><a href="setup.html#fork-and-clone-the-github-repository"><i class="fa fa-check"></i><b>0.4</b> Fork and Clone the Github Repository</a></li>
<li class="chapter" data-level="0.5" data-path="setup.html"><a href="setup.html#install-r-packages"><i class="fa fa-check"></i><b>0.5</b> Install R Packages</a></li>
<li class="chapter" data-level="0.6" data-path="setup.html"><a href="setup.html#create-rmarkdown-file"><i class="fa fa-check"></i><b>0.6</b> Create Rmarkdown file</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="satellite.html"><a href="satellite.html"><i class="fa fa-check"></i><b>1</b> Satellite</a><ul>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#objectives"><i class="fa fa-check"></i>Objectives</a><ul>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#question"><i class="fa fa-check"></i>Question</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#study-area-delhi-india"><i class="fa fa-check"></i>Study area: Delhi, India</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#learning-outcomes"><i class="fa fa-check"></i>Learning outcomes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1.1" data-path="satellite.html"><a href="satellite.html#get-city-boundary"><i class="fa fa-check"></i><b>1.1</b> Get city boundary</a></li>
<li class="chapter" data-level="1.2" data-path="satellite.html"><a href="satellite.html#browse-datasets-tag-no2"><i class="fa fa-check"></i><b>1.2</b> Browse datasets, tag no2</a></li>
<li class="chapter" data-level="1.3" data-path="satellite.html"><a href="satellite.html#view-dataset-info"><i class="fa fa-check"></i><b>1.3</b> View dataset info</a></li>
<li class="chapter" data-level="1.4" data-path="satellite.html"><a href="satellite.html#questions"><i class="fa fa-check"></i><b>1.4</b> Questions</a><ul>
<li class="chapter" data-level="1.4.1" data-path="satellite.html"><a href="satellite.html#answers"><i class="fa fa-check"></i><b>1.4.1</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="satellite.html"><a href="satellite.html#launch-code-editor-with-dataset"><i class="fa fa-check"></i><b>1.5</b> Launch Code Editor with dataset</a></li>
<li class="chapter" data-level="1.6" data-path="satellite.html"><a href="satellite.html#run-the-initial-dataset-script"><i class="fa fa-check"></i><b>1.6</b> Run the initial dataset script</a></li>
<li class="chapter" data-level="1.7" data-path="satellite.html"><a href="satellite.html#modify-the-script-so-satellite-layer-is-semi-transparent"><i class="fa fa-check"></i><b>1.7</b> Modify the script so satellite layer is semi-transparent</a></li>
<li class="chapter" data-level="1.8" data-path="satellite.html"><a href="satellite.html#add-city-polygon-asset"><i class="fa fa-check"></i><b>1.8</b> Add city polygon asset</a></li>
<li class="chapter" data-level="1.9" data-path="satellite.html"><a href="satellite.html#add-to-city-to-map"><i class="fa fa-check"></i><b>1.9</b> Add to city to map</a></li>
<li class="chapter" data-level="1.10" data-path="satellite.html"><a href="satellite.html#create-time-series-chart"><i class="fa fa-check"></i><b>1.10</b> Create time series chart</a></li>
<li class="chapter" data-level="1.11" data-path="satellite.html"><a href="satellite.html#expand-dates-to-all-available"><i class="fa fa-check"></i><b>1.11</b> Expand dates to all available</a></li>
<li class="chapter" data-level="1.12" data-path="satellite.html"><a href="satellite.html#download-csv"><i class="fa fa-check"></i><b>1.12</b> Download CSV</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#conclusions"><i class="fa fa-check"></i>Conclusions</a></li>
<li class="chapter" data-level="1.13" data-path="satellite.html"><a href="satellite.html#your-turn"><i class="fa fa-check"></i><b>1.13</b> Your Turn</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#further-resources"><i class="fa fa-check"></i>Further Resources</a><ul>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#google-earth-engine"><i class="fa fa-check"></i>Google Earth Engine</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sentiment.html"><a href="sentiment.html"><i class="fa fa-check"></i><b>2</b> Sentiment</a><ul>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#status-not-ready"><i class="fa fa-check"></i>STATUS: NOT READY</a></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#objectives-1"><i class="fa fa-check"></i>Objectives</a><ul>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#question-1"><i class="fa fa-check"></i>Question</a></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#technical-motivation"><i class="fa fa-check"></i>Technical Motivation</a></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#approach"><i class="fa fa-check"></i>Approach</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="sentiment.html"><a href="sentiment.html#setup-twitter-token"><i class="fa fa-check"></i><b>2.1</b> Setup Twitter token</a></li>
<li class="chapter" data-level="2.2" data-path="sentiment.html"><a href="sentiment.html#load-r-packages"><i class="fa fa-check"></i><b>2.2</b> Load R packages</a></li>
<li class="chapter" data-level="2.3" data-path="sentiment.html"><a href="sentiment.html#search-twitter"><i class="fa fa-check"></i><b>2.3</b> Search Twitter</a></li>
<li class="chapter" data-level="2.4" data-path="sentiment.html"><a href="sentiment.html#calculate-dictionary-score"><i class="fa fa-check"></i><b>2.4</b> Calculate dictionary score</a></li>
<li class="chapter" data-level="2.5" data-path="sentiment.html"><a href="sentiment.html#twitter-test-dataset"><i class="fa fa-check"></i><b>2.5</b> Twitter test dataset</a></li>
<li class="chapter" data-level="2.6" data-path="sentiment.html"><a href="sentiment.html#introducing-tensorflow"><i class="fa fa-check"></i><b>2.6</b> Introducing TensorFlow</a><ul>
<li class="chapter" data-level="2.6.1" data-path="sentiment.html"><a href="sentiment.html#text-classification"><i class="fa fa-check"></i><b>2.6.1</b> Text classification</a></li>
<li class="chapter" data-level="2.6.2" data-path="sentiment.html"><a href="sentiment.html#not-working-on-bens-laptop-trained-model-on-image-classification"><i class="fa fa-check"></i><b>2.6.2</b> not working on Ben’s laptop: trained model on image classification</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Clean Air in the Time of COVID</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sentiment" class="section level1">
<h1><span class="header-section-number">Lesson 2</span> Sentiment</h1>
<div id="status-not-ready" class="section level2 unnumbered">
<h2>STATUS: NOT READY</h2>
<p>Sorry, this teaching module is not ready for students to run through just yet. I experienced a couple issues:</p>
<ol style="list-style-type: decimal">
<li><p>The free Twitter developer API access only goes back 1 week. I upgraded to Premium for the Full Archive search going back to Twitter beginnings in 2006, but couldn’t get the <a href="https://rtweet.info/reference/search_fullarchive.html"><code>rtweet::search_fullarchive()</code></a> to return any results. I finally got a week’s worth of results with a more manual approach, <a href="https://github.com/bbest/meds-demo/blob/master/_tweet-premium.R">_tweet-premium.R</a>, but then became time constrained to get the rest.</p></li>
<li><p>I wanted to use an existing trained model, i.e. “transfer learning”, to improve accuracy and not get into the weeds of convolutional neural net model design, but had trouble getting <a href="https://tensorflow.rstudio.com/guide/tfhub/intro/">tfhub</a> to work.</p></li>
</ol>
</div>
<div id="objectives-1" class="section level2 unnumbered objectives">
<h2>Objectives</h2>
<div id="question-1" class="section level3 unnumbered">
<h3>Question</h3>
<p>How has sentiment around air quality and clean energy changed since air became cleaner?</p>
<p><strong>Background</strong>. In anticipation of the 2008 Summer Olympics in Beijing the Chinese government imposed strict rules to clean up the air. The people got used to better air and now Beijing is consistently improved. Will this hiatus to bad air be temporary or incite a push towards cleaner energy. For a compelling summary, check out the podcast <a href="https://99percentinvisible.org/episode/the-natural-experiment/">The Natural Experiment - 99% Invisible</a>.</p>
</div>
<div id="technical-motivation" class="section level3 unnumbered">
<h3>Technical Motivation</h3>
<p>Sentiment can be evaluated as either positive or negative. This <strong>binary classification</strong> is the most basic response for <strong>machine learning</strong>, thus a good example for a lesson on machine learning. Text however can have many complicated forms, such as negating terms (eg “happy” vs “<em><strong>not</strong></em> happy”), which makes it a good candidate for <strong>deep learning</strong>.</p>
</div>
<div id="approach" class="section level3 unnumbered">
<h3>Approach</h3>
<ol style="list-style-type: decimal">
<li>Get a set of sample tweets before and after the lockdown with some of key terms.</li>
<li>Lookup tweeted words with dictionaries labelling positive or negative, and tally the score. Bren’s own Casey O’Hara &amp; Jessica Couture already explained this approach well in their Eco-Data-Science workshop <a href="https://github.com/oharac/text_workshop">Text analysis with R</a> (2019-02-05).</li>
<li>Introduce TensorFlow starting with a pre-trained model.</li>
<li>Use a sample of the Sentiment140 twitter dataset to train an existing natural language processing (NLP) model.</li>
<li>Predict that over time.</li>
</ol>
</div>
</div>
<div id="prerequisites-2" class="section level2 unnumbered prereq">
<h2>Prerequisites</h2>
<p>A <strong>Twitter developer account</strong> is required to download tweets and access the <a href="https://developer.twitter.com/en/dashboard" class="uri">https://developer.twitter.com/en/dashboard</a>. You’ll need to apply via the <a href="https://developer.twitter.com/en/apply-for-access">Twitter developer signup</a>.</p>
<p>I recieved an email for clarification and had the account approved and running by the end of the day.</p>
</div>
<div id="setup-twitter-token" class="section level2">
<h2><span class="header-section-number">2.1</span> Setup Twitter token</h2>
<p>We’ll use the <a href="https://rtweet.info">rtweet</a> R package to get twitter data. You’ll need to setup an access token though after applying for a Twitter API</p>
<p>See <a href="https://rtweet.info/articles/auth.html">Obtaining and using access tokens • rtweet</a>:</p>
<ul>
<li>Creating a Twitter App</li>
<li>Authorization methods
<ul>
<li><ol start="2" style="list-style-type: decimal">
<li>Access token/secret method</li>
</ol></li>
</ul></li>
<li><p>Authorization in future R sessions</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(rtweet)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">get_token</span>()</a></code></pre></div></li>
</ul>
<p>For <code>search_fullarchive</code> also tried to setup <a href="https://developer.twitter.com/en/account/environments">Dev environment — Twitter Developers</a>, but that didn’t seem to work.</p>
</div>
<div id="load-r-packages" class="section level2">
<h2><span class="header-section-number">2.2</span> Load R packages</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># load libraries ----</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># use librarian to load libraries, installing if needed</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;librarian&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;librarian&quot;</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="kw">library</span>(<span class="st">&quot;librarian&quot;</span>)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">pkgs &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  <span class="co"># utility</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="st">&quot;here&quot;</span>,<span class="st">&quot;glue&quot;</span>,<span class="st">&quot;stringr&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;readr&quot;</span>,<span class="st">&quot;ggplot2&quot;</span>,<span class="st">&quot;purrr&quot;</span>,</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">  <span class="co"># airquality</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  <span class="co">#&quot;ropensci/ropenaq&quot;,</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  <span class="co"># spatial</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  <span class="st">&quot;sf&quot;</span>,<span class="co">#&quot;ggmap&quot;,&quot;mapview&quot;,&quot;leaflet&quot;,</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">  <span class="co"># text</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">  <span class="st">&quot;rtweet&quot;</span>,<span class="st">&quot;tidytext&quot;</span>,<span class="st">&quot;textdata&quot;</span>,</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">  <span class="co"># tensorflow</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="st">&quot;tensorflow&quot;</span>,<span class="st">&quot;keras&quot;</span>,<span class="st">&quot;tfhub&quot;</span>,<span class="st">&quot;rstudio/tfds&quot;</span>,<span class="st">&quot;pins&quot;</span>)</a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="kw">shelf</span>(pkgs)</a></code></pre></div>
</div>
<div id="search-twitter" class="section level2">
<h2><span class="header-section-number">2.3</span> Search Twitter</h2>
<p>Using hashtags from <span class="citation">(Gurajala, Dhaniyala, and Matthews <a href="#ref-gurajalaUnderstandingPublicResponse2019">2019</a>)</span>: #AIRPOLLUTION #AIRQUALITY #CLEANAIR #HAZE #OZONE #PARTICLES #PARTICULATES #PM25 #PM2.5 #PM10 #POLLUTION #SMOG #EMISSIONS</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">city_geo &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data/city_Delhi-India.geojson&quot;</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">now_rds  &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data/twitter_aq_delhi_now.rds&quot;</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">yr1_rds  &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data/twitter_aq_delhi_1yr.rds&quot;</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">aq_hashes &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;#AIRPOLLUTION #AIRQUALITY #CLEANAIR #HAZE #OZONE #PARTICLES #PARTICULATES #PM25 #PM2.5 #PM10 #POLLUTION #SMOG #EMISSIONS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="st">  </span><span class="kw">str_replace_all</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot; OR &quot;</span>)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">q_bb &lt;-<span class="st"> </span><span class="kw">read_sf</span>(city_geo) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="st">  </span><span class="kw">st_bbox</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="st">  </span><span class="kw">glue_data</span>(</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">  <span class="st">&quot;bounding_box:[{xmin} {ymin} {xmax} {ymax}]&quot;</span>)</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">geocode_str &lt;-<span class="st"> </span><span class="kw">read_sf</span>(city_geo) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="st">  </span><span class="kw">glue_data</span>(</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">  <span class="st">&quot;{round(lat, 4)},{round(lon, 4)},{round(r_mi*2, 2)}mi&quot;</span>)</a>
<a class="sourceLine" id="cb11-16" data-line-number="16"></a>
<a class="sourceLine" id="cb11-17" data-line-number="17">q_geo &lt;-<span class="st"> </span><span class="kw">read_sf</span>(city_geo) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="st">  </span><span class="kw">glue_data</span>(</a>
<a class="sourceLine" id="cb11-19" data-line-number="19">  <span class="st">&quot;point_radius:[{round(lon, 4)} {round(lat, 4)} {round(r_mi*2, 2)}mi]&quot;</span>)</a>
<a class="sourceLine" id="cb11-20" data-line-number="20"></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(now_rds)){</a>
<a class="sourceLine" id="cb11-22" data-line-number="22">  tbl &lt;-<span class="st"> </span><span class="kw">search_tweets</span>(</a>
<a class="sourceLine" id="cb11-23" data-line-number="23">    <span class="dt">q       =</span> aq_hashes,</a>
<a class="sourceLine" id="cb11-24" data-line-number="24">    <span class="dt">geocode =</span> geocode_str,</a>
<a class="sourceLine" id="cb11-25" data-line-number="25">    <span class="dt">n       =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb11-26" data-line-number="26">  </a>
<a class="sourceLine" id="cb11-27" data-line-number="27">  <span class="kw">saveRDS</span>(tbl, now_rds)</a>
<a class="sourceLine" id="cb11-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb11-29" data-line-number="29"></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(yr1_rds)){</a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="co">#if (F){</span></a>
<a class="sourceLine" id="cb11-32" data-line-number="32">  tbl_yr1 &lt;-<span class="st"> </span><span class="kw">search_fullarchive</span>(</a>
<a class="sourceLine" id="cb11-33" data-line-number="33">    <span class="dt">env_name =</span> <span class="st">&quot;research&quot;</span>,</a>
<a class="sourceLine" id="cb11-34" data-line-number="34">    <span class="dt">fromDate =</span> <span class="st">&quot;201905190000&quot;</span>,</a>
<a class="sourceLine" id="cb11-35" data-line-number="35">    <span class="dt">toDate   =</span> <span class="st">&quot;201905260000&quot;</span>,</a>
<a class="sourceLine" id="cb11-36" data-line-number="36">    <span class="dt">q        =</span> <span class="kw">glue</span>(<span class="st">&quot;({aq_hashes}) {q_geo}&quot;</span>),</a>
<a class="sourceLine" id="cb11-37" data-line-number="37">    <span class="dt">n        =</span> <span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb11-38" data-line-number="38">  </a>
<a class="sourceLine" id="cb11-39" data-line-number="39">  <span class="kw">saveRDS</span>(tbl_yr1, yr1_rds)</a>
<a class="sourceLine" id="cb11-40" data-line-number="40">}</a></code></pre></div>
</div>
<div id="calculate-dictionary-score" class="section level2">
<h2><span class="header-section-number">2.4</span> Calculate dictionary score</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">s_b &lt;-<span class="st"> </span><span class="kw">get_sentiments</span>(<span class="st">&#39;bing&#39;</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># s_a &lt;- get_sentiments(&#39;afinn&#39;)</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># s_n &lt;- get_sentiments(&#39;nrc&#39;)</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">tbl &lt;-<span class="st"> </span><span class="kw">readRDS</span>(now_rds)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co"># clean out non-ascii, twitter handles, and urls</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">tbl &lt;-<span class="st"> </span>tbl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">    <span class="dt">text_clean =</span> text <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="st">      </span><span class="kw">str_replace_all</span>(<span class="st">&quot;[^[:ascii:]]&quot;</span>, <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="st">      </span><span class="kw">tolower</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="st">      </span><span class="kw">str_replace_all</span>(<span class="st">&quot;@[^ ]+&quot;</span>, <span class="st">&quot;_usr_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="st">      </span><span class="kw">str_replace_all</span>(<span class="st">&quot;http[^ ]+&quot;</span>, <span class="st">&quot;_url_&quot;</span>))</a>
<a class="sourceLine" id="cb12-15" data-line-number="15"></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co"># tweets to words</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">words &lt;-<span class="st"> </span>tbl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="st">  </span><span class="kw">select</span>(status_id, created_at, screen_name, text_clean) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="st">  </span><span class="kw">unnest_tokens</span>(<span class="dt">output =</span> word, <span class="dt">input =</span> text_clean, <span class="dt">token =</span> <span class="st">&quot;words&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">  </span><span class="kw">anti_join</span>(stop_words, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="st">  </span><span class="kw">left_join</span>(s_b, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">    <span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb12-24" data-line-number="24">      <span class="op">~</span>sentiment, <span class="op">~</span>score,</a>
<a class="sourceLine" id="cb12-25" data-line-number="25">      <span class="st">&quot;positive&quot;</span>, <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">      <span class="st">&quot;negative&quot;</span>, <span class="dv">-1</span>),</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">    <span class="dt">by =</span> <span class="st">&quot;sentiment&quot;</span>)</a>
<a class="sourceLine" id="cb12-28" data-line-number="28"></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co"># tally score per tweet</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30">tbl &lt;-<span class="st"> </span>tbl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb12-32" data-line-number="32">    words <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="st">      </span><span class="kw">group_by</span>(status_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="st">      </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb12-35" data-line-number="35">        <span class="dt">score =</span> <span class="kw">mean</span>(score, <span class="dt">na.rm =</span> T)),</a>
<a class="sourceLine" id="cb12-36" data-line-number="36">    <span class="dt">by =</span> <span class="st">&quot;status_id&quot;</span>)</a>
<a class="sourceLine" id="cb12-37" data-line-number="37"></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="kw">hist</span>(tbl<span class="op">$</span>score)</a></code></pre></div>
<p><img src="MEDS-demo_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">mean</span>(<span class="kw">na.omit</span>(tbl<span class="op">$</span>score))</a></code></pre></div>
<pre><code>## [1] -0.2354447</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">nrow</span>(tbl)</a></code></pre></div>
<pre><code>## [1] 607</code></pre>
</div>
<div id="twitter-test-dataset" class="section level2">
<h2><span class="header-section-number">2.5</span> Twitter test dataset</h2>
<p><a href="http://help.sentiment140.com/for-students">For Academics - Sentiment140 - A Twitter Sentiment Analysis Tool</a></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">s140_csv &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data/sentiment140_testdata.manual.2009.06.14.csv&quot;</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">s140 &lt;-<span class="st"> </span><span class="kw">read_csv</span>(</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  s140_csv, <span class="dt">col_names =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">    <span class="st">&quot;polarity&quot;</span>, <span class="st">&quot;status_id&quot;</span>, <span class="st">&quot;created_at&quot;</span>, <span class="st">&quot;query&quot;</span>, <span class="st">&quot;screen_name&quot;</span>, <span class="st">&quot;text&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">    <span class="co"># convert negative 0 -&gt; -1, neutral 2 -&gt; 0, positive 4 -&gt; 1  </span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">    <span class="dt">polarity =</span> <span class="kw">recode</span>(polarity, <span class="st">`</span><span class="dt">0</span><span class="st">`</span> =<span class="st"> </span><span class="dv">-1</span>, <span class="st">`</span><span class="dt">2</span><span class="st">`</span> =<span class="st"> </span><span class="dv">0</span>, <span class="st">`</span><span class="dt">4</span><span class="st">`</span> =<span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb17-8" data-line-number="8"></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co"># clean out non-ascii, twitter handles, and urls</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">s140 &lt;-<span class="st"> </span>s140 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">    <span class="dt">text_clean =</span> text <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"><span class="st">      </span><span class="kw">str_replace_all</span>(<span class="st">&quot;[^[:ascii:]]&quot;</span>, <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="st">      </span><span class="kw">tolower</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15"><span class="st">      </span><span class="kw">str_replace_all</span>(<span class="st">&quot;@[^ ]+&quot;</span>, <span class="st">&quot;_usr_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"><span class="st">      </span><span class="kw">str_replace_all</span>(<span class="st">&quot;http[^ ]+&quot;</span>, <span class="st">&quot;_url_&quot;</span>))</a>
<a class="sourceLine" id="cb17-17" data-line-number="17"></a>
<a class="sourceLine" id="cb17-18" data-line-number="18"><span class="co"># tweets to words</span></a>
<a class="sourceLine" id="cb17-19" data-line-number="19">words &lt;-<span class="st"> </span>s140 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(status_id, created_at, screen_name, text_clean) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-21" data-line-number="21"><span class="st">  </span><span class="kw">unnest_tokens</span>(<span class="dt">output =</span> word, <span class="dt">input =</span> text_clean, <span class="dt">token =</span> <span class="st">&quot;words&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-22" data-line-number="22"><span class="st">  </span><span class="kw">anti_join</span>(stop_words, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-23" data-line-number="23"><span class="st">  </span><span class="kw">left_join</span>(s_b, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-24" data-line-number="24"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb17-25" data-line-number="25">    <span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb17-26" data-line-number="26">      <span class="op">~</span>sentiment, <span class="op">~</span>score,</a>
<a class="sourceLine" id="cb17-27" data-line-number="27">      <span class="st">&quot;positive&quot;</span>,  <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb17-28" data-line-number="28">      <span class="st">&quot;negative&quot;</span>, <span class="dv">-1</span>),</a>
<a class="sourceLine" id="cb17-29" data-line-number="29">    <span class="dt">by =</span> <span class="st">&quot;sentiment&quot;</span>)</a>
<a class="sourceLine" id="cb17-30" data-line-number="30"></a>
<a class="sourceLine" id="cb17-31" data-line-number="31"><span class="co"># tally score per tweet</span></a>
<a class="sourceLine" id="cb17-32" data-line-number="32">s140 &lt;-<span class="st"> </span>s140 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-33" data-line-number="33"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb17-34" data-line-number="34">    words <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-35" data-line-number="35"><span class="st">      </span><span class="kw">group_by</span>(status_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-36" data-line-number="36"><span class="st">      </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb17-37" data-line-number="37">        <span class="dt">score =</span> <span class="kw">mean</span>(score, <span class="dt">na.rm =</span> T)),</a>
<a class="sourceLine" id="cb17-38" data-line-number="38">    <span class="dt">by =</span> <span class="st">&quot;status_id&quot;</span>)</a>
<a class="sourceLine" id="cb17-39" data-line-number="39"></a>
<a class="sourceLine" id="cb17-40" data-line-number="40"><span class="kw">hist</span>(s140<span class="op">$</span>score)</a></code></pre></div>
<p><img src="MEDS-demo_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">nrow</span>(s140)</a></code></pre></div>
<pre><code>## [1] 498</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">mean</span>(<span class="kw">na.omit</span>(s140<span class="op">$</span>score))</a></code></pre></div>
<pre><code>## [1] -0.07255595</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co"># performance</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">s140 &lt;-<span class="st"> </span>s140 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">    <span class="dt">accurate_dict =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb22-5" data-line-number="5">      polarity <span class="op">==</span><span class="st"> </span><span class="dv">-1</span> <span class="op">&amp;</span><span class="st"> </span>score <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span>T,</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">      polarity <span class="op">==</span><span class="st">  </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>score <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span>T,</a>
<a class="sourceLine" id="cb22-7" data-line-number="7">      polarity <span class="op">==</span><span class="st">  </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>score <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span>T,</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">      T <span class="op">~</span><span class="st"> </span>F))</a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="kw">select</span>(s140, polarity, score, accurate_dict)</a></code></pre></div>
<pre><code>## # A tibble: 498 x 3
##    polarity score accurate_dict
##       &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;        
##  1        1     1 TRUE         
##  2        1     1 TRUE         
##  3        1    -1 FALSE        
##  4        1     0 FALSE        
##  5        1     1 TRUE         
##  6        1     1 TRUE         
##  7       -1    -1 TRUE         
##  8        1   NaN FALSE        
##  9        1     1 TRUE         
## 10        1     1 TRUE         
## # … with 488 more rows</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">sum</span>(s140<span class="op">$</span>accurate_dict <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(s140))</a></code></pre></div>
<pre><code>## [1] 0.3975904</code></pre>
</div>
<div id="introducing-tensorflow" class="section level2">
<h2><span class="header-section-number">2.6</span> Introducing TensorFlow</h2>
<p><a href="https://blogs.rstudio.com/ai/posts/2019-12-18-tfhub-0.7.0/">RStudio AI Blog: tfhub: R interface to TensorFlow Hub</a></p>
<p>You need to install these Python packages once:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">tensorflow<span class="op">::</span><span class="kw">install_tensorflow</span>()</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">keras<span class="op">::</span><span class="kw">install_keras</span>()</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">tfhub<span class="op">::</span><span class="kw">install_tfhub</span>()</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">tfds<span class="op">::</span><span class="kw">install_tfds</span>()</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">reticulate<span class="op">::</span><span class="kw">py_config</span>()</a></code></pre></div>
<div id="text-classification" class="section level3">
<h3><span class="header-section-number">2.6.1</span> Text classification</h3>
<p><a href="https://tensorflow.rstudio.com/tutorials/beginners/basic-ml/tutorial_basic_text_classification/">Text Classification</a></p>
<p>The dataset was downloaded from <a href="https://www.kaggle.com/nltkdata/movie-review#movie_review.csv">Movie Reviews | Kaggle</a>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co">#df &lt;- read_csv(here(&quot;data/movie_review.csv&quot;))</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">df &lt;-<span class="st"> </span>s140 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">    <span class="co"># convert negative -1 -&gt; neg, neutral 0 -&gt; neu, positive 1 -&gt; pos</span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5">    <span class="dt">tag =</span> <span class="kw">recode</span>(polarity, <span class="st">`</span><span class="dt">-1</span><span class="st">`</span> =<span class="st"> &quot;neg&quot;</span>, <span class="st">`</span><span class="dt">0</span><span class="st">`</span> =<span class="st"> &quot;neu&quot;</span>, <span class="st">`</span><span class="dt">1</span><span class="st">`</span> =<span class="st"> &quot;pos&quot;</span>))</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(tag)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   tag       n
##   &lt;chr&gt; &lt;int&gt;
## 1 neg     177
## 2 neu     139
## 3 pos     182</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">df<span class="op">$</span>text[<span class="dv">1</span>]</a></code></pre></div>
<pre><code>## [1] &quot;@stellargirl I loooooooovvvvvveee my Kindle2. Not that the DX is cool, but the 2 is fantastic in its own right.&quot;</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co"># split our dataset into training and testing</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2">training_id &lt;-<span class="st"> </span><span class="kw">sample.int</span>(<span class="kw">nrow</span>(df), <span class="dt">size =</span> <span class="kw">nrow</span>(df)<span class="op">*</span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">training    &lt;-<span class="st"> </span>df[training_id,]</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">testing     &lt;-<span class="st"> </span>df[<span class="op">-</span>training_id,]</a>
<a class="sourceLine" id="cb31-5" data-line-number="5"></a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="co"># distribution of number of words in each review?</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7"><span class="co">#df$text %&gt;% </span></a>
<a class="sourceLine" id="cb31-8" data-line-number="8">df<span class="op">$</span>text_clean <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-9" data-line-number="9"><span class="st">  </span><span class="kw">strsplit</span>(<span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-10" data-line-number="10"><span class="st">  </span><span class="kw">sapply</span>(length) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11"><span class="st">  </span><span class="kw">summary</span>()</a></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    2.00    8.00   12.00   13.73   18.75   31.00</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co"># create padded arrays</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">num_words &lt;-<span class="st"> </span><span class="dv">10000</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3">max_length &lt;-<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4">text_vectorization &lt;-<span class="st"> </span><span class="kw">layer_text_vectorization</span>(</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">  <span class="dt">max_tokens =</span> num_words, </a>
<a class="sourceLine" id="cb33-6" data-line-number="6">  <span class="dt">output_sequence_length =</span> max_length,)</a>
<a class="sourceLine" id="cb33-7" data-line-number="7"></a>
<a class="sourceLine" id="cb33-8" data-line-number="8">text_vectorization <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb33-9" data-line-number="9"><span class="st">  </span><span class="co">#adapt(df$text)</span></a>
<a class="sourceLine" id="cb33-10" data-line-number="10"><span class="st">  </span><span class="kw">adapt</span>(df<span class="op">$</span>text_clean)</a>
<a class="sourceLine" id="cb33-11" data-line-number="11"></a>
<a class="sourceLine" id="cb33-12" data-line-number="12"><span class="co"># </span><span class="al">TODO</span><span class="co"> see https://github.com/tensorflow/tensorflow/pull/34529</span></a>
<a class="sourceLine" id="cb33-13" data-line-number="13"><span class="kw">get_vocabulary</span>(text_vectorization) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">20</span>)</a></code></pre></div>
<pre><code>##  [1] &quot;the&quot;   &quot;i&quot;     &quot;to&quot;    &quot;url&quot;   &quot;a&quot;     &quot;usr&quot;   &quot;is&quot;    &quot;and&quot;   &quot;for&quot;  
## [10] &quot;my&quot;    &quot;at&quot;    &quot;of&quot;    &quot;in&quot;    &quot;it&quot;    &quot;with&quot;  &quot;time&quot;  &quot;you&quot;   &quot;just&quot; 
## [19] &quot;on&quot;    &quot;night&quot;</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">text_vectorization</span>(<span class="kw">matrix</span>(df<span class="op">$</span>text[<span class="dv">1</span>], <span class="dt">ncol =</span> <span class="dv">1</span>))</a></code></pre></div>
<pre><code>## tf.Tensor(
## [[   1    3 1322   11   47   34   29    2  381    8  299   38    2   85
##      8 1594   14   31  520  208    0    0    0    0    0    0    0    0
##      0    0    0    0    0    0    0    0    0    0    0    0    0    0
##      0    0    0    0    0    0    0    0]], shape=(1, 50), dtype=int64)</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dtype =</span> <span class="st">&quot;string&quot;</span>)</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"></a>
<a class="sourceLine" id="cb37-3" data-line-number="3">output &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-4" data-line-number="4"><span class="st">  </span><span class="kw">text_vectorization</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-5" data-line-number="5"><span class="st">  </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> num_words <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">output_dim =</span> <span class="dv">16</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-6" data-line-number="6"><span class="st">  </span><span class="kw">layer_global_average_pooling_1d</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-7" data-line-number="7"><span class="st">  </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">16</span>, <span class="dt">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-8" data-line-number="8"><span class="st">  </span><span class="kw">layer_dropout</span>(<span class="fl">0.5</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9"><span class="st">  </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">1</span>, <span class="dt">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</a>
<a class="sourceLine" id="cb37-10" data-line-number="10"></a>
<a class="sourceLine" id="cb37-11" data-line-number="11">model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(input, output)</a>
<a class="sourceLine" id="cb37-12" data-line-number="12"></a>
<a class="sourceLine" id="cb37-13" data-line-number="13"><span class="co"># configure the model to use an optimizer and a loss function</span></a>
<a class="sourceLine" id="cb37-14" data-line-number="14">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(</a>
<a class="sourceLine" id="cb37-15" data-line-number="15">  <span class="dt">optimizer =</span> <span class="st">&#39;adam&#39;</span>,</a>
<a class="sourceLine" id="cb37-16" data-line-number="16">  <span class="dt">loss =</span> <span class="st">&#39;binary_crossentropy&#39;</span>,</a>
<a class="sourceLine" id="cb37-17" data-line-number="17">  <span class="dt">metrics =</span> <span class="kw">list</span>(<span class="st">&#39;accuracy&#39;</span>))</a>
<a class="sourceLine" id="cb37-18" data-line-number="18"></a>
<a class="sourceLine" id="cb37-19" data-line-number="19"><span class="co"># train the model</span></a>
<a class="sourceLine" id="cb37-20" data-line-number="20">history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(</a>
<a class="sourceLine" id="cb37-21" data-line-number="21">  training<span class="op">$</span>text,</a>
<a class="sourceLine" id="cb37-22" data-line-number="22">  <span class="kw">as.numeric</span>(training<span class="op">$</span>tag <span class="op">==</span><span class="st"> &quot;pos&quot;</span>),</a>
<a class="sourceLine" id="cb37-23" data-line-number="23">  <span class="dt">epochs =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb37-24" data-line-number="24">  <span class="dt">batch_size =</span> <span class="dv">512</span>,</a>
<a class="sourceLine" id="cb37-25" data-line-number="25">  <span class="dt">validation_split =</span> <span class="fl">0.2</span>,</a>
<a class="sourceLine" id="cb37-26" data-line-number="26">  <span class="dt">verbose=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb37-27" data-line-number="27"></a>
<a class="sourceLine" id="cb37-28" data-line-number="28"><span class="co"># evaluate the model</span></a>
<a class="sourceLine" id="cb37-29" data-line-number="29">results &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">evaluate</span>(testing<span class="op">$</span>text, <span class="kw">as.numeric</span>(testing<span class="op">$</span>tag <span class="op">==</span><span class="st"> &quot;pos&quot;</span>), <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb37-30" data-line-number="30">results</a></code></pre></div>
<pre><code>##      loss  accuracy 
## 0.6820824 0.6500000</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co"># graph accuracy and loss over iterations</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw">plot</span>(history)</a></code></pre></div>
<p><img src="MEDS-demo_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">results</a></code></pre></div>
<pre><code>##      loss  accuracy 
## 0.6820824 0.6500000</code></pre>
</div>
<div id="not-working-on-bens-laptop-trained-model-on-image-classification" class="section level3">
<h3><span class="header-section-number">2.6.2</span> not working on Ben’s laptop: trained model on image classification</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="kw">library</span>(tfhub)</a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="kw">library</span>(keras)</a>
<a class="sourceLine" id="cb42-3" data-line-number="3"></a>
<a class="sourceLine" id="cb42-4" data-line-number="4">layer_mobilenet &lt;-<span class="st"> </span><span class="kw">layer_hub</span>(</a>
<a class="sourceLine" id="cb42-5" data-line-number="5">  <span class="dt">handle =</span> <span class="st">&quot;https://tfhub.dev/google/tf2-preview/mobilenet_v2/classification/4&quot;</span>)</a>
<a class="sourceLine" id="cb42-6" data-line-number="6"></a>
<a class="sourceLine" id="cb42-7" data-line-number="7">input  &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">224</span>, <span class="dv">224</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb42-8" data-line-number="8">output &lt;-<span class="st"> </span><span class="kw">layer_mobilenet</span>(input)</a>
<a class="sourceLine" id="cb42-9" data-line-number="9">model  &lt;-<span class="st"> </span><span class="kw">keras_model</span>(input, output)</a>
<a class="sourceLine" id="cb42-10" data-line-number="10"><span class="kw">summary</span>(model)</a></code></pre></div>
<p>The <code>layer_hub()</code> function above however kept throwing errors like this:</p>
<pre><code>Error in py_call_impl(callable, dots$args, dots$keywords) : 
  OSError: SavedModel file does not exist at: /var/folders/2r/grqvdjfn04361tzk8mh60st40000gn/T/tfhub_modules/426589ad685896ab7954855255a52db3442cb38d/{saved_model.pbtxt|saved_model.pb}</code></pre>
<p>There’s a lot of Python and R communication that can get easily confused between versions. So let’s switch to a clean installation by using Docker. <a href="https://docs.docker.com/get-docker/">Install Docker</a> if you don’t already have it.</p>
<p>Then per <a href="https://hub.docker.com/r/rocker/tensorflow">rocker/tensorflow - Docker Hub</a> run the following to get a clean RStudio instance with all the TensorFlow and Python dependencies properly installed:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="ex">docker</span> run -e PASSWORD=mu -p 8787:8787 --name ml4r rocker/ml </a></code></pre></div>
<p>Visit <a href="http://localhost:8787/" class="uri">http://localhost:8787/</a> and enter username rstudio, password mu.</p>
<p>Then in the Terminal of RStudio run:</p>
<pre><code>git clone https://github.com/bbest/meds-demo</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">img &lt;-<span class="st"> </span><span class="kw">image_load</span>(<span class="st">&quot;data/grace-hopper.jpg&quot;</span>, <span class="dt">target_size =</span> <span class="kw">c</span>(<span class="dv">224</span>,<span class="dv">224</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="kw">image_to_array</span>()</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">img &lt;-<span class="st"> </span>img<span class="op">/</span><span class="dv">255</span></a>
<a class="sourceLine" id="cb46-4" data-line-number="4"><span class="kw">dim</span>(img) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">dim</span>(img))</a>
<a class="sourceLine" id="cb46-5" data-line-number="5">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(model, img)</a>
<a class="sourceLine" id="cb46-6" data-line-number="6"><span class="kw">imagenet_decode_predictions</span>(pred[,<span class="op">-</span><span class="dv">1</span>,<span class="dt">drop=</span><span class="ot">FALSE</span>])[[<span class="dv">1</span>]]</a></code></pre></div>

<div id="refs" class="references">
<div>
<p>Gorelick, Noel, Matt Hancher, Mike Dixon, Simon Ilyushchenko, David Thau, and Rebecca Moore. 2017. “Google Earth Engine: Planetary-Scale Geospatial Analysis for Everyone.” <em>Remote Sensing of Environment</em>, Big Remotely Sensed Data: Tools, applications and experiences, 202 (December): 18–27. <a href="https://doi.org/10.1016/j.rse.2017.06.031">https://doi.org/10.1016/j.rse.2017.06.031</a>.</p>
</div>
<div>
<p>Gurajala, Supraja, Suresh Dhaniyala, and Jeanna N. Matthews. 2019. “Understanding Public Response to Air Quality Using Tweet Analysis.” <em>Social Media + Society</em> 5 (3). SAGE Publications Ltd: 2056305119867656. <a href="https://doi.org/10.1177/2056305119867656">https://doi.org/10.1177/2056305119867656</a>.</p>
</div>
</div>
</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-gurajalaUnderstandingPublicResponse2019">
<p>Gurajala, Supraja, Suresh Dhaniyala, and Jeanna N. Matthews. 2019. “Understanding Public Response to Air Quality Using Tweet Analysis.” <em>Social Media + Society</em> 5 (3). SAGE Publications Ltd: 2056305119867656. <a href="https://doi.org/10.1177/2056305119867656">https://doi.org/10.1177/2056305119867656</a>.</p>
</div>
</div>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/lesson.js"></script>
            </section>

          </div>
        </div>
      </div>
<a href="satellite.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ecoquants/r3-workshop/blob/master/02_sentiment.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["MEDS-demo.pdf"],
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

</body>

</html>
