<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Lesson 2 Sentiment | Clean Air in the Time of COVID</title>
  <meta name="description" content="These materials are for a 45 minute teaching demonstration oriented towards students in the new Masters in Environmental Data Science at UCSB." />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Lesson 2 Sentiment | Clean Air in the Time of COVID" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="These materials are for a 45 minute teaching demonstration oriented towards students in the new Masters in Environmental Data Science at UCSB." />
  <meta name="github-repo" content="bbest/meds-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Lesson 2 Sentiment | Clean Air in the Time of COVID" />
  
  <meta name="twitter:description" content="These materials are for a 45 minute teaching demonstration oriented towards students in the new Masters in Environmental Data Science at UCSB." />
  

<meta name="author" content="Ben Best, PhD" />


<meta name="date" content="2020-06-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="satellite.html"/>
<link rel="next" href="integration.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="style/style.css" type="text/css" />
<link rel="stylesheet" href="style/lesson.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">MEDS demo</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#motivation"><i class="fa fa-check"></i>Motivation</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#technologies"><i class="fa fa-check"></i>Technologies</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#motivating-use-case"><i class="fa fa-check"></i>Motivating Use Case</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i>Setup</a><ul>
<li class="chapter" data-level="0.1" data-path="setup.html"><a href="setup.html#apply-for-accounts"><i class="fa fa-check"></i><b>0.1</b> Apply for accounts</a><ul>
<li class="chapter" data-level="0.1.1" data-path="setup.html"><a href="setup.html#google-earth-engine-gee-account"><i class="fa fa-check"></i><b>0.1.1</b> Google Earth Engine (GEE) account</a></li>
<li class="chapter" data-level="0.1.2" data-path="setup.html"><a href="setup.html#twitter-developer-account"><i class="fa fa-check"></i><b>0.1.2</b> Twitter developer account</a></li>
</ul></li>
<li class="chapter" data-level="0.2" data-path="setup.html"><a href="setup.html#install-software"><i class="fa fa-check"></i><b>0.2</b> Install software</a></li>
<li class="chapter" data-level="0.3" data-path="setup.html"><a href="setup.html#launch-rstudio"><i class="fa fa-check"></i><b>0.3</b> Launch RStudio</a></li>
<li class="chapter" data-level="0.4" data-path="setup.html"><a href="setup.html#fork-and-clone-the-github-repository"><i class="fa fa-check"></i><b>0.4</b> Fork and Clone the Github Repository</a></li>
<li class="chapter" data-level="0.5" data-path="setup.html"><a href="setup.html#install-r-packages"><i class="fa fa-check"></i><b>0.5</b> Install R Packages</a></li>
<li class="chapter" data-level="0.6" data-path="setup.html"><a href="setup.html#create-rmarkdown-file"><i class="fa fa-check"></i><b>0.6</b> Create Rmarkdown file</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="satellite.html"><a href="satellite.html"><i class="fa fa-check"></i><b>1</b> Satellite</a><ul>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#objectives"><i class="fa fa-check"></i>Objectives</a><ul>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#question"><i class="fa fa-check"></i>Question</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#study-area-delhi-india"><i class="fa fa-check"></i>Study area: Delhi, India</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#learning-outcomes"><i class="fa fa-check"></i>Learning outcomes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1.1" data-path="satellite.html"><a href="satellite.html#get-city-boundary"><i class="fa fa-check"></i><b>1.1</b> Get city boundary</a></li>
<li class="chapter" data-level="1.2" data-path="satellite.html"><a href="satellite.html#browse-datasets-tag-no2"><i class="fa fa-check"></i><b>1.2</b> Browse datasets, tag no2</a></li>
<li class="chapter" data-level="1.3" data-path="satellite.html"><a href="satellite.html#view-dataset-info"><i class="fa fa-check"></i><b>1.3</b> View dataset info</a></li>
<li class="chapter" data-level="1.4" data-path="satellite.html"><a href="satellite.html#questions"><i class="fa fa-check"></i><b>1.4</b> Questions</a><ul>
<li class="chapter" data-level="1.4.1" data-path="satellite.html"><a href="satellite.html#answers"><i class="fa fa-check"></i><b>1.4.1</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="satellite.html"><a href="satellite.html#launch-code-editor-with-dataset"><i class="fa fa-check"></i><b>1.5</b> Launch Code Editor with dataset</a></li>
<li class="chapter" data-level="1.6" data-path="satellite.html"><a href="satellite.html#run-the-initial-dataset-script"><i class="fa fa-check"></i><b>1.6</b> Run the initial dataset script</a></li>
<li class="chapter" data-level="1.7" data-path="satellite.html"><a href="satellite.html#modify-the-script-so-satellite-layer-is-semi-transparent"><i class="fa fa-check"></i><b>1.7</b> Modify the script so satellite layer is semi-transparent</a></li>
<li class="chapter" data-level="1.8" data-path="satellite.html"><a href="satellite.html#add-city-polygon-asset"><i class="fa fa-check"></i><b>1.8</b> Add city polygon asset</a></li>
<li class="chapter" data-level="1.9" data-path="satellite.html"><a href="satellite.html#add-to-city-to-map"><i class="fa fa-check"></i><b>1.9</b> Add to city to map</a></li>
<li class="chapter" data-level="1.10" data-path="satellite.html"><a href="satellite.html#create-time-series-chart"><i class="fa fa-check"></i><b>1.10</b> Create time series chart</a></li>
<li class="chapter" data-level="1.11" data-path="satellite.html"><a href="satellite.html#expand-dates-to-all-available"><i class="fa fa-check"></i><b>1.11</b> Expand dates to all available</a></li>
<li class="chapter" data-level="1.12" data-path="satellite.html"><a href="satellite.html#download-csv"><i class="fa fa-check"></i><b>1.12</b> Download CSV</a></li>
<li class="chapter" data-level="1.13" data-path="satellite.html"><a href="satellite.html#your-turn"><i class="fa fa-check"></i><b>1.13</b> Your Turn</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#conclusions"><i class="fa fa-check"></i>Conclusions</a></li>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#further-resources"><i class="fa fa-check"></i>Further Resources</a><ul>
<li class="chapter" data-level="" data-path="satellite.html"><a href="satellite.html#google-earth-engine"><i class="fa fa-check"></i>Google Earth Engine</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="sentiment.html"><a href="sentiment.html"><i class="fa fa-check"></i><b>2</b> Sentiment</a><ul>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#objectives-1"><i class="fa fa-check"></i>Objectives</a><ul>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#question-1"><i class="fa fa-check"></i>Question</a></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#technical-motivation"><i class="fa fa-check"></i>Technical Motivation</a></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#approach"><i class="fa fa-check"></i>Approach</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="sentiment.html"><a href="sentiment.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="sentiment.html"><a href="sentiment.html#load-r-packages"><i class="fa fa-check"></i><b>2.1</b> Load R packages</a></li>
<li class="chapter" data-level="2.2" data-path="sentiment.html"><a href="sentiment.html#setup-twitter"><i class="fa fa-check"></i><b>2.2</b> Setup Twitter</a></li>
<li class="chapter" data-level="2.3" data-path="sentiment.html"><a href="sentiment.html#define-queries-for-air-quality-and-clean-energy"><i class="fa fa-check"></i><b>2.3</b> Define queries for air quality and clean energy</a></li>
<li class="chapter" data-level="2.4" data-path="sentiment.html"><a href="sentiment.html#define-spatial-and-temporal-extent"><i class="fa fa-check"></i><b>2.4</b> Define spatial and temporal extent</a></li>
<li class="chapter" data-level="2.5" data-path="sentiment.html"><a href="sentiment.html#get-tweets-iterating-over-queries-months"><i class="fa fa-check"></i><b>2.5</b> Get tweets, iterating over queries &amp; months</a></li>
<li class="chapter" data-level="2.6" data-path="sentiment.html"><a href="sentiment.html#classify-sentiment-of-tweets-over-time-using-lexicon"><i class="fa fa-check"></i><b>2.6</b> Classify sentiment of tweets over time, using lexicon</a></li>
<li class="chapter" data-level="2.7" data-path="sentiment.html"><a href="sentiment.html#twitter-sentiment140-dataset"><i class="fa fa-check"></i><b>2.7</b> Twitter Sentiment140 dataset</a></li>
<li class="chapter" data-level="2.8" data-path="sentiment.html"><a href="sentiment.html#train-tensorflow-model-with-sentiment140"><i class="fa fa-check"></i><b>2.8</b> Train TensorFlow model with Sentiment140</a></li>
<li class="chapter" data-level="2.9" data-path="sentiment.html"><a href="sentiment.html#classify-sentiment-of-tweets-over-time-using-tensorflow"><i class="fa fa-check"></i><b>2.9</b> Classify sentiment of tweets over time, using TensorFlow</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="integration.html"><a href="integration.html"><i class="fa fa-check"></i><b>3</b> Integration</a><ul>
<li class="chapter" data-level="3.1" data-path="integration.html"><a href="integration.html#time-series-plot-of-satellite-sentiment-metrics"><i class="fa fa-check"></i><b>3.1</b> Time series plot of satellite &amp; sentiment metrics</a></li>
<li class="chapter" data-level="3.2" data-path="integration.html"><a href="integration.html#box-plot-of-satellite-sentiment-metrics-beforeafter-lockdown"><i class="fa fa-check"></i><b>3.2</b> Box plot of satellite &amp; sentiment metrics before/after lockdown</a></li>
<li class="chapter" data-level="" data-path="integration.html"><a href="integration.html#references"><i class="fa fa-check"></i>References</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Clean Air in the Time of COVID</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sentiment" class="section level1">
<h1><span class="header-section-number">Lesson 2</span> Sentiment</h1>
<div id="objectives-1" class="section level2 unnumbered objectives">
<h2>Objectives</h2>
<div id="question-1" class="section level3 unnumbered">
<h3>Question</h3>
<p>How has sentiment around air quality and clean energy changed since air became cleaner?</p>
<p><strong>Background</strong>. In anticipation of the 2008 Summer Olympics in Beijing the Chinese government imposed strict rules to clean up the air. The people got used to better air and now Beijing is consistently improved. Will this hiatus to bad air be temporary or incite a push towards cleaner energy. For a compelling summary, check out the podcast <a href="https://99percentinvisible.org/episode/the-natural-experiment/">The Natural Experiment - 99% Invisible</a>.</p>
</div>
<div id="technical-motivation" class="section level3 unnumbered">
<h3>Technical Motivation</h3>
<p>Sentiment can be evaluated as either positive or negative. This <strong>binary classification</strong> is the most basic response for <strong>machine learning</strong>, thus a good example for a lesson on machine learning. Text however can have many complicated forms, such as negating terms (eg “happy” vs “<em><strong>not</strong></em> happy”) and sarcasm (“this air quality is so great! as if.”), which makes it a good candidate for <strong>deep learning</strong>.</p>
</div>
<div id="approach" class="section level3 unnumbered">
<h3>Approach</h3>
<ol style="list-style-type: decimal">
<li>Get tweets about air quality and clean energy throughout the period of the satellite data availability for NO<sub>2</sub>.</li>
<li>Lookup tweeted words with a lexicon labelling positive or negative, and tally the score. Bren’s own Casey O’Hara &amp; Jessica Couture already explained this approach well in their Eco-Data-Science workshop <a href="https://github.com/oharac/text_workshop">Text analysis with R</a> (2019-02-05).</li>
<li>Use a Twitter dataset pre-labeled with sentiment to train a TensorFlow text classification model. Compare accuracy of TensorFlow model with the lexicon results.</li>
<li>Classify twitter sentiment with the TensorFlow model over time for air quality and clean energy..</li>
</ol>
</div>
</div>
<div id="prerequisites-2" class="section level2 unnumbered prereq">
<h2>Prerequisites</h2>
<p>A <strong>Twitter developer account</strong> is required to download tweets and access the <a href="https://developer.twitter.com/en/dashboard" class="uri">https://developer.twitter.com/en/dashboard</a>. You’ll need to apply via the <a href="https://developer.twitter.com/en/apply-for-access">Twitter developer signup</a>.</p>
<p>I recieved an email for clarification and had the account approved and running by the end of the day.</p>
</div>
<div id="load-r-packages" class="section level2">
<h2><span class="header-section-number">2.1</span> Load R packages</h2>
<p>The <code>librarian</code> R package will load packages, installing them if needed, including from Github.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="sentiment.html#cb11-1"></a><span class="co"># load libraries ----</span></span>
<span id="cb11-2"><a href="sentiment.html#cb11-2"></a><span class="co"># use librarian to load libraries, installing if needed</span></span>
<span id="cb11-3"><a href="sentiment.html#cb11-3"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;librarian&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;librarian&quot;</span>)</span>
<span id="cb11-4"><a href="sentiment.html#cb11-4"></a><span class="kw">library</span>(<span class="st">&quot;librarian&quot;</span>)</span>
<span id="cb11-5"><a href="sentiment.html#cb11-5"></a></span>
<span id="cb11-6"><a href="sentiment.html#cb11-6"></a>pkgs &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb11-7"><a href="sentiment.html#cb11-7"></a>  <span class="co"># utility</span></span>
<span id="cb11-8"><a href="sentiment.html#cb11-8"></a>  <span class="st">&quot;here&quot;</span>,<span class="st">&quot;glue&quot;</span>,</span>
<span id="cb11-9"><a href="sentiment.html#cb11-9"></a>  <span class="st">&quot;readr&quot;</span>,<span class="st">&quot;dplyr&quot;</span>,<span class="st">&quot;tidyr&quot;</span>,<span class="st">&quot;purrr&quot;</span>,<span class="st">&quot;scales&quot;</span>,</span>
<span id="cb11-10"><a href="sentiment.html#cb11-10"></a>  <span class="st">&quot;lubridate&quot;</span>,<span class="st">&quot;stringr&quot;</span>,</span>
<span id="cb11-11"><a href="sentiment.html#cb11-11"></a>  <span class="co"># plotting</span></span>
<span id="cb11-12"><a href="sentiment.html#cb11-12"></a>  <span class="st">&quot;ggplot2&quot;</span>,<span class="st">&quot;plotly&quot;</span>,</span>
<span id="cb11-13"><a href="sentiment.html#cb11-13"></a>  <span class="co"># spatial</span></span>
<span id="cb11-14"><a href="sentiment.html#cb11-14"></a>  <span class="st">&quot;sf&quot;</span>,</span>
<span id="cb11-15"><a href="sentiment.html#cb11-15"></a>  <span class="co"># text</span></span>
<span id="cb11-16"><a href="sentiment.html#cb11-16"></a>  <span class="st">&quot;rtweet&quot;</span>,<span class="st">&quot;tidytext&quot;</span>,<span class="st">&quot;textdata&quot;</span>,</span>
<span id="cb11-17"><a href="sentiment.html#cb11-17"></a>  <span class="co"># tensorflow</span></span>
<span id="cb11-18"><a href="sentiment.html#cb11-18"></a>  <span class="st">&quot;tensorflow&quot;</span>,<span class="st">&quot;keras&quot;</span>)</span>
<span id="cb11-19"><a href="sentiment.html#cb11-19"></a><span class="kw">shelf</span>(pkgs)</span></code></pre></div>
</div>
<div id="setup-twitter" class="section level2">
<h2><span class="header-section-number">2.2</span> Setup Twitter</h2>
<p>Start off using the excellent <a href="https://rtweet.info">rtweet</a> R package to get twitter data. You’ll need to setup an access token though after applying for a Twitter developer account. See <a href="https://rtweet.info/articles/auth.html">Obtaining and using access tokens • rtweet</a> to:</p>
<ul>
<li><p>Create a Twitter App</p></li>
<li><p>Authorization methods</p>
<ul>
<li><ol start="2" style="list-style-type: decimal">
<li>Access token/secret method</li>
</ol></li>
</ul></li>
<li><p>Authorization in future R sessions</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="sentiment.html#cb12-1"></a><span class="kw">library</span>(rtweet)</span>
<span id="cb12-2"><a href="sentiment.html#cb12-2"></a><span class="kw">get_token</span>()</span></code></pre></div></li>
</ul>
<p>The free Twitter developer API access only goes back 1 week. I upgraded to Premium ($99/month for 50 requests per month) for the Full Archive search going back to Twitter beginnings in 2006. Unfortunately I couldn’t get the <a href="https://rtweet.info/reference/search_fullarchive.html"><code>rtweet::search_fullarchive()</code></a> to return any results. I had to write a custom function <code>get_tweets_premium()</code> and added it to <a href="https://github.com/bbest/meds-demo/blob/master/functions.R"><code>functions.R</code></a>.</p>
<p>I called the app “clean-air-covid” and developer environment label “research” as well as saved the API key and secret in my home folder under <code>~/private</code>.</p>
<p><strong>IMPORTANT</strong>: Keep the Twitter API ‘key’ and ‘secret’ secret. That means that if you are pushing these files to a Github public repository, then you’ll need to save these outside the repo, which is why I chose <code>~/private</code>.</p>
<p>For more, see:</p>
<ul>
<li><a href="https://developer.twitter.com/en/account/environments">Dev environment — Twitter Developers</a></li>
<li><a href="https://developer.twitter.com/en/docs/tweets/search/overview">Search Tweets - Twitter Developers</a></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="sentiment.html#cb13-1"></a><span class="co"># Twitter API parameters</span></span>
<span id="cb13-2"><a href="sentiment.html#cb13-2"></a>env_label &lt;-<span class="st"> &quot;research&quot;</span></span>
<span id="cb13-3"><a href="sentiment.html#cb13-3"></a>appname   &lt;-<span class="st"> &quot;clean-air-covid&quot;</span></span>
<span id="cb13-4"><a href="sentiment.html#cb13-4"></a>key       &lt;-<span class="st"> </span><span class="kw">readLines</span>(<span class="st">&quot;~/private/twitter_clean-air-covid_api-key.txt&quot;</span>)</span>
<span id="cb13-5"><a href="sentiment.html#cb13-5"></a>secret    &lt;-<span class="st"> </span><span class="kw">readLines</span>(<span class="st">&quot;~/private/twitter_clean-air-covid_api-key-secret.txt&quot;</span>)</span></code></pre></div>
</div>
<div id="define-queries-for-air-quality-and-clean-energy" class="section level2">
<h2><span class="header-section-number">2.3</span> Define queries for air quality and clean energy</h2>
<p>These terms were pulled from the following references after a little Google Scholar searching:</p>
<ul>
<li><p><strong>air quality</strong> <span class="citation">(Gurajala, Dhaniyala, and Matthews <a href="#ref-gurajalaUnderstandingPublicResponse2019" role="doc-biblioref">2019</a>)</span></p></li>
<li><p><strong>clean energy</strong> <span class="citation">(Sluban et al. <a href="#ref-slubanSentimentLeaningInfluential2015" role="doc-biblioref">2015</a>)</span></p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="sentiment.html#cb14-1"></a>query_air    &lt;-<span class="st"> &quot;#AIRPOLLUTION OR #AIRQUALITY OR #CLEANAIR OR #HAZE OR #OZONE OR #PARTICLES OR #PARTICULATES OR #PM25 OR #PM2.5 OR #PM10 OR #POLLUTION OR #SMOG OR #EMISSIONS&quot;</span></span>
<span id="cb14-2"><a href="sentiment.html#cb14-2"></a></span>
<span id="cb14-3"><a href="sentiment.html#cb14-3"></a>query_energy &lt;-<span class="st"> &quot;#green OR #cleanenergy OR #renewable OR #renewableenergy OR #sustainable OR #sustainability OR #solar OR #wind OR #solarpower OR #windpower OR #photovoltaic OR #biomass OR #biofuel OR #biofuels&quot;</span></span>
<span id="cb14-4"><a href="sentiment.html#cb14-4"></a></span>
<span id="cb14-5"><a href="sentiment.html#cb14-5"></a>queries &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">air =</span> query_air, <span class="dt">energy =</span> query_energy)</span></code></pre></div>
<p>Note: Twitter searches are not case-sensitive.</p>
</div>
<div id="define-spatial-and-temporal-extent" class="section level2">
<h2><span class="header-section-number">2.4</span> Define spatial and temporal extent</h2>
<p>Let’s get the spatial and temporal extents from our previous satellite analysis:</p>
<ul>
<li><p><strong>Spatial</strong>. Let’s get the centroid from the city’s polygon boundary (<code>data/city_Delhi-India.geojson</code>) and use the maximum radius (25 miles) for Twitter searches.</p></li>
<li><p><strong>Temporal</strong>. Let’s get tweets for the same timespan as the downloaded CSV of NO<sub>2</sub> satellite data (<code>data/no2_delhi-india_ee-chart.csv</code>).</p></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="sentiment.html#cb15-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb15-2"><a href="sentiment.html#cb15-2"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb15-3"><a href="sentiment.html#cb15-3"></a></span>
<span id="cb15-4"><a href="sentiment.html#cb15-4"></a><span class="co"># variables &amp; files</span></span>
<span id="cb15-5"><a href="sentiment.html#cb15-5"></a>loc_name &lt;-<span class="st"> &quot;delhi&quot;</span></span>
<span id="cb15-6"><a href="sentiment.html#cb15-6"></a>city_geo &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="kw">glue</span>(<span class="st">&quot;data/city_{loc_name}.geojson&quot;</span>))</span>
<span id="cb15-7"><a href="sentiment.html#cb15-7"></a>no2_csv  &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="kw">glue</span>(<span class="st">&quot;data/no2_{loc_name}_ee-chart.csv&quot;</span>))</span>
<span id="cb15-8"><a href="sentiment.html#cb15-8"></a></span>
<span id="cb15-9"><a href="sentiment.html#cb15-9"></a><span class="co"># spatial</span></span>
<span id="cb15-10"><a href="sentiment.html#cb15-10"></a>loc_lonlat    &lt;-<span class="st"> </span><span class="kw">read_sf</span>(city_geo) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-11"><a href="sentiment.html#cb15-11"></a><span class="st">  </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-12"><a href="sentiment.html#cb15-12"></a><span class="st">  </span><span class="kw">select</span>(lon, lat) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-13"><a href="sentiment.html#cb15-13"></a><span class="st">  </span><span class="kw">as.numeric</span>()</span>
<span id="cb15-14"><a href="sentiment.html#cb15-14"></a>loc_radius_mi &lt;-<span class="st"> </span><span class="dv">25</span> <span class="co"># max radius for tweet point_radius search</span></span>
<span id="cb15-15"><a href="sentiment.html#cb15-15"></a></span>
<span id="cb15-16"><a href="sentiment.html#cb15-16"></a><span class="co"># temporal</span></span>
<span id="cb15-17"><a href="sentiment.html#cb15-17"></a>date_range &lt;-<span class="st"> </span><span class="kw">read_csv</span>(no2_csv) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-18"><a href="sentiment.html#cb15-18"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb15-19"><a href="sentiment.html#cb15-19"></a>    <span class="dt">date =</span> <span class="kw">mdy</span>(<span class="st">`</span><span class="dt">system:time_start</span><span class="st">`</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-20"><a href="sentiment.html#cb15-20"></a><span class="st">  </span><span class="kw">pull</span>(date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-21"><a href="sentiment.html#cb15-21"></a><span class="st">  </span><span class="kw">range</span>()</span>
<span id="cb15-22"><a href="sentiment.html#cb15-22"></a>date_months &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">floor_date</span>(date_range[<span class="dv">1</span>], <span class="dt">unit =</span> <span class="st">&quot;month&quot;</span>), date_range[<span class="dv">2</span>], <span class="dt">by =</span> <span class="st">&quot;months&quot;</span>)</span>
<span id="cb15-23"><a href="sentiment.html#cb15-23"></a><span class="kw">range</span>(date_months)</span></code></pre></div>
<pre><code>## [1] &quot;2018-07-01&quot; &quot;2020-05-01&quot;</code></pre>
</div>
<div id="get-tweets-iterating-over-queries-months" class="section level2">
<h2><span class="header-section-number">2.5</span> Get tweets, iterating over queries &amp; months</h2>
<p>Let’s now iterate over each query (<code>query_air</code> and <code>query_energy</code>) and each month over our temporal period of interest (<code>date_range</code>).</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="sentiment.html#cb17-1"></a><span class="co"># define: get_tweets_premium(), clean_tweet()</span></span>
<span id="cb17-2"><a href="sentiment.html#cb17-2"></a><span class="kw">source</span>(<span class="kw">here</span>(<span class="st">&quot;functions.R&quot;</span>)) </span>
<span id="cb17-3"><a href="sentiment.html#cb17-3"></a></span>
<span id="cb17-4"><a href="sentiment.html#cb17-4"></a>tweets_all_csv &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="kw">glue</span>(<span class="st">&#39;data/tweets_{loc_name}.csv&#39;</span>))</span>
<span id="cb17-5"><a href="sentiment.html#cb17-5"></a></span>
<span id="cb17-6"><a href="sentiment.html#cb17-6"></a>n_queries &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">names</span>(queries))</span>
<span id="cb17-7"><a href="sentiment.html#cb17-7"></a>n_months  &lt;-<span class="st"> </span><span class="kw">length</span>(date_months)</span>
<span id="cb17-8"><a href="sentiment.html#cb17-8"></a></span>
<span id="cb17-9"><a href="sentiment.html#cb17-9"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(tweets_all_csv)){</span>
<span id="cb17-10"><a href="sentiment.html#cb17-10"></a>  </span>
<span id="cb17-11"><a href="sentiment.html#cb17-11"></a>  dir_tweets &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data/tweets&quot;</span>)</span>
<span id="cb17-12"><a href="sentiment.html#cb17-12"></a>  <span class="kw">dir.create</span>(dir_tweets, <span class="dt">showWarnings =</span> F)</span>
<span id="cb17-13"><a href="sentiment.html#cb17-13"></a></span>
<span id="cb17-14"><a href="sentiment.html#cb17-14"></a>  <span class="co"># iterate over queries</span></span>
<span id="cb17-15"><a href="sentiment.html#cb17-15"></a>  <span class="cf">for</span> (i_query <span class="cf">in</span> <span class="kw">seq_along</span>(<span class="kw">names</span>(queries))){ <span class="co"># i_query = 1</span></span>
<span id="cb17-16"><a href="sentiment.html#cb17-16"></a>    </span>
<span id="cb17-17"><a href="sentiment.html#cb17-17"></a>    query_name &lt;-<span class="st"> </span><span class="kw">names</span>(queries)[i_query]</span>
<span id="cb17-18"><a href="sentiment.html#cb17-18"></a>    query      &lt;-<span class="st"> </span>queries[[query_name]]</span>
<span id="cb17-19"><a href="sentiment.html#cb17-19"></a>    <span class="kw">message</span>(<span class="kw">glue</span>(<span class="st">&quot;query {i_query}/{n_queries} {query_name}: {query}&quot;</span>))</span>
<span id="cb17-20"><a href="sentiment.html#cb17-20"></a>    </span>
<span id="cb17-21"><a href="sentiment.html#cb17-21"></a>    <span class="co"># iterate over temporal range by month</span></span>
<span id="cb17-22"><a href="sentiment.html#cb17-22"></a>    <span class="cf">for</span> (i_month <span class="cf">in</span> <span class="kw">seq_along</span>(date_months)){ <span class="co"># i_month = 23</span></span>
<span id="cb17-23"><a href="sentiment.html#cb17-23"></a>      </span>
<span id="cb17-24"><a href="sentiment.html#cb17-24"></a>      date_beg &lt;-<span class="st"> </span>date_months[i_month]</span>
<span id="cb17-25"><a href="sentiment.html#cb17-25"></a>      date_end &lt;-<span class="st"> </span>date_beg <span class="op">+</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">1</span>)</span>
<span id="cb17-26"><a href="sentiment.html#cb17-26"></a>      ym_beg   &lt;-<span class="st"> </span><span class="kw">format</span>(date_beg, <span class="st">&quot;%Y-%m&quot;</span>)</span>
<span id="cb17-27"><a href="sentiment.html#cb17-27"></a>      </span>
<span id="cb17-28"><a href="sentiment.html#cb17-28"></a>      tweets_csv &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="kw">glue</span>(<span class="st">&#39;{dir_tweets}/tweets_{loc_name}_{query_name}_{ym_beg}.csv&#39;</span>))</span>
<span id="cb17-29"><a href="sentiment.html#cb17-29"></a>      </span>
<span id="cb17-30"><a href="sentiment.html#cb17-30"></a>      <span class="cf">if</span> (<span class="kw">file.exists</span>(tweets_csv)) <span class="cf">next</span></span>
<span id="cb17-31"><a href="sentiment.html#cb17-31"></a>      </span>
<span id="cb17-32"><a href="sentiment.html#cb17-32"></a>      <span class="kw">message</span>(<span class="kw">glue</span>(<span class="st">&quot;  month {i_month}/{n_months} {date_beg}: {basename(tweets_csv)}&quot;</span>))</span>
<span id="cb17-33"><a href="sentiment.html#cb17-33"></a>      </span>
<span id="cb17-34"><a href="sentiment.html#cb17-34"></a>      tbl &lt;-<span class="st"> </span><span class="kw">get_tweets_premium</span>(</span>
<span id="cb17-35"><a href="sentiment.html#cb17-35"></a>        env_label, appname, key, secret, query,</span>
<span id="cb17-36"><a href="sentiment.html#cb17-36"></a>        date_beg, date_end, loc_lonlat, loc_radius_mi,</span>
<span id="cb17-37"><a href="sentiment.html#cb17-37"></a>        tweets_csv)</span>
<span id="cb17-38"><a href="sentiment.html#cb17-38"></a>    }</span>
<span id="cb17-39"><a href="sentiment.html#cb17-39"></a>  }</span>
<span id="cb17-40"><a href="sentiment.html#cb17-40"></a>  </span>
<span id="cb17-41"><a href="sentiment.html#cb17-41"></a>  <span class="co"># read tweets into table</span></span>
<span id="cb17-42"><a href="sentiment.html#cb17-42"></a>  regexp &lt;-<span class="st"> &quot;tweets_([a-z]+)_([a-z]+)_([0-9-]+).csv&quot;</span></span>
<span id="cb17-43"><a href="sentiment.html#cb17-43"></a>  tweets &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb17-44"><a href="sentiment.html#cb17-44"></a>    <span class="dt">csv =</span> <span class="kw">list.files</span>(<span class="kw">here</span>(<span class="st">&quot;data/tweets&quot;</span>), <span class="dt">full.names =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb17-45"><a href="sentiment.html#cb17-45"></a><span class="st">    </span><span class="kw">mutate</span>(</span>
<span id="cb17-46"><a href="sentiment.html#cb17-46"></a>      <span class="dt">loc_name   =</span> <span class="kw">str_replace</span>(<span class="kw">basename</span>(csv), regexp, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>),</span>
<span id="cb17-47"><a href="sentiment.html#cb17-47"></a>      <span class="dt">query_name =</span> <span class="kw">str_replace</span>(<span class="kw">basename</span>(csv), regexp, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>),</span>
<span id="cb17-48"><a href="sentiment.html#cb17-48"></a>      <span class="dt">ym_str     =</span> <span class="kw">str_replace</span>(<span class="kw">basename</span>(csv), regexp, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">3&quot;</span>),</span>
<span id="cb17-49"><a href="sentiment.html#cb17-49"></a>      <span class="dt">ym_date    =</span> <span class="kw">as.Date</span>(<span class="kw">glue</span>(<span class="st">&quot;{ym_str}-01&quot;</span>)),</span>
<span id="cb17-50"><a href="sentiment.html#cb17-50"></a>      <span class="dt">data       =</span> <span class="kw">map</span>(csv, read_csv),</span>
<span id="cb17-51"><a href="sentiment.html#cb17-51"></a>      <span class="dt">n_tweets   =</span> <span class="kw">map_int</span>(data, nrow)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb17-52"><a href="sentiment.html#cb17-52"></a><span class="st">    </span><span class="kw">unnest</span>(data)</span>
<span id="cb17-53"><a href="sentiment.html#cb17-53"></a>  </span>
<span id="cb17-54"><a href="sentiment.html#cb17-54"></a>  <span class="kw">write_csv</span>(tweets, tweets_all_csv)</span>
<span id="cb17-55"><a href="sentiment.html#cb17-55"></a>} <span class="cf">else</span> {</span>
<span id="cb17-56"><a href="sentiment.html#cb17-56"></a>  tweets &lt;-<span class="st"> </span><span class="kw">read_csv</span>(tweets_all_csv)</span>
<span id="cb17-57"><a href="sentiment.html#cb17-57"></a>}</span>
<span id="cb17-58"><a href="sentiment.html#cb17-58"></a></span>
<span id="cb17-59"><a href="sentiment.html#cb17-59"></a>g &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span></span>
<span id="cb17-60"><a href="sentiment.html#cb17-60"></a><span class="st">  </span><span class="kw">group_by</span>(query_name, ym_date, n_tweets) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb17-61"><a href="sentiment.html#cb17-61"></a><span class="st">  </span><span class="kw">summarize</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb17-62"><a href="sentiment.html#cb17-62"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">query =</span> query_name) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb17-63"><a href="sentiment.html#cb17-63"></a><span class="st">  </span><span class="kw">ggplot</span>(</span>
<span id="cb17-64"><a href="sentiment.html#cb17-64"></a>    <span class="kw">aes</span>(<span class="dt">x =</span> ym_date, <span class="dt">y =</span> n_tweets, <span class="dt">color =</span> query)) <span class="op">+</span></span>
<span id="cb17-65"><a href="sentiment.html#cb17-65"></a><span class="st">  </span><span class="kw">geom_line</span>()</span>
<span id="cb17-66"><a href="sentiment.html#cb17-66"></a><span class="kw">ggplotly</span>(g)</span></code></pre></div>
<div id="htmlwidget-b98a777388e01edd634f" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-b98a777388e01edd634f">{"x":{"data":[{"x":[17713,17744,17775,17805,17836,17866,17897,17928,17956,17987,18017,18048,18078,18109,18140,18170,18201,18231,18262,18293,18322,18353,18383],"y":[3,2,3,8,22,11,6,2,64,82,62,94,48,80,83,286,500,116,97,70,100,82,33],"text":["ym_date: 2018-07-01<br />n_tweets:   3<br />query: air","ym_date: 2018-08-01<br />n_tweets:   2<br />query: air","ym_date: 2018-09-01<br />n_tweets:   3<br />query: air","ym_date: 2018-10-01<br />n_tweets:   8<br />query: air","ym_date: 2018-11-01<br />n_tweets:  22<br />query: air","ym_date: 2018-12-01<br />n_tweets:  11<br />query: air","ym_date: 2019-01-01<br />n_tweets:   6<br />query: air","ym_date: 2019-02-01<br />n_tweets:   2<br />query: air","ym_date: 2019-03-01<br />n_tweets:  64<br />query: air","ym_date: 2019-04-01<br />n_tweets:  82<br />query: air","ym_date: 2019-05-01<br />n_tweets:  62<br />query: air","ym_date: 2019-06-01<br />n_tweets:  94<br />query: air","ym_date: 2019-07-01<br />n_tweets:  48<br />query: air","ym_date: 2019-08-01<br />n_tweets:  80<br />query: air","ym_date: 2019-09-01<br />n_tweets:  83<br />query: air","ym_date: 2019-10-01<br />n_tweets: 286<br />query: air","ym_date: 2019-11-01<br />n_tweets: 500<br />query: air","ym_date: 2019-12-01<br />n_tweets: 116<br />query: air","ym_date: 2020-01-01<br />n_tweets:  97<br />query: air","ym_date: 2020-02-01<br />n_tweets:  70<br />query: air","ym_date: 2020-03-01<br />n_tweets: 100<br />query: air","ym_date: 2020-04-01<br />n_tweets:  82<br />query: air","ym_date: 2020-05-01<br />n_tweets:  33<br />query: air"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)","dash":"solid"},"hoveron":"points","name":"air","legendgroup":"air","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[17713,17744,17775,17805,17836,17866,17897,17928,17956,17987,18017,18048,18078,18109,18140,18170,18201,18231,18262,18293,18322,18353,18383],"y":[14,20,27,28,25,26,19,13,46,56,63,120,107,75,110,104,84,97,137,124,124,84,79],"text":["ym_date: 2018-07-01<br />n_tweets:  14<br />query: energy","ym_date: 2018-08-01<br />n_tweets:  20<br />query: energy","ym_date: 2018-09-01<br />n_tweets:  27<br />query: energy","ym_date: 2018-10-01<br />n_tweets:  28<br />query: energy","ym_date: 2018-11-01<br />n_tweets:  25<br />query: energy","ym_date: 2018-12-01<br />n_tweets:  26<br />query: energy","ym_date: 2019-01-01<br />n_tweets:  19<br />query: energy","ym_date: 2019-02-01<br />n_tweets:  13<br />query: energy","ym_date: 2019-03-01<br />n_tweets:  46<br />query: energy","ym_date: 2019-04-01<br />n_tweets:  56<br />query: energy","ym_date: 2019-05-01<br />n_tweets:  63<br />query: energy","ym_date: 2019-06-01<br />n_tweets: 120<br />query: energy","ym_date: 2019-07-01<br />n_tweets: 107<br />query: energy","ym_date: 2019-08-01<br />n_tweets:  75<br />query: energy","ym_date: 2019-09-01<br />n_tweets: 110<br />query: energy","ym_date: 2019-10-01<br />n_tweets: 104<br />query: energy","ym_date: 2019-11-01<br />n_tweets:  84<br />query: energy","ym_date: 2019-12-01<br />n_tweets:  97<br />query: energy","ym_date: 2020-01-01<br />n_tweets: 137<br />query: energy","ym_date: 2020-02-01<br />n_tweets: 124<br />query: energy","ym_date: 2020-03-01<br />n_tweets: 124<br />query: energy","ym_date: 2020-04-01<br />n_tweets:  84<br />query: energy","ym_date: 2020-05-01<br />n_tweets:  79<br />query: energy"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"solid"},"hoveron":"points","name":"energy","legendgroup":"energy","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":40.1826484018265,"l":43.1050228310502},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[17679.5,18416.5],"tickmode":"array","ticktext":["2018-07","2019-01","2019-07","2020-01"],"tickvals":[17713,17897,18078,18262],"categoryorder":"array","categoryarray":["2018-07","2019-01","2019-07","2020-01"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"ym_date","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-22.9,524.9],"tickmode":"array","ticktext":["0","100","200","300","400","500"],"tickvals":[0,100,200,300,400,500],"categoryorder":"array","categoryarray":["0","100","200","300","400","500"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"n_tweets","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"annotations":[{"text":"query","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","showSendToCloud":false},"source":"A","attrs":{"53752ba183c":{"x":{},"y":{},"colour":{},"type":"scatter"}},"cur_data":"53752ba183c","visdat":{"53752ba183c":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="classify-sentiment-of-tweets-over-time-using-lexicon" class="section level2">
<h2><span class="header-section-number">2.6</span> Classify sentiment of tweets over time, using lexicon</h2>
<p>Now let’s borrow from <a href="https://github.com/oharac/text_workshop">Text analysis with R</a> (2019-02-05), created by Bren’s own Casey O’Hara &amp; Jessica Couture as an <a href="https://eco-data-science.github.io/">Eco-Data-Science</a> workshop, to use get a sentiment score based on a lexicon, or dictionary of words with assigned sentiment assigned.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="sentiment.html#cb18-1"></a>lex_bing &lt;-<span class="st"> </span><span class="kw">get_sentiments</span>(<span class="st">&#39;bing&#39;</span>)</span>
<span id="cb18-2"><a href="sentiment.html#cb18-2"></a></span>
<span id="cb18-3"><a href="sentiment.html#cb18-3"></a><span class="co"># clean out non-ascii, twitter handles, and urls</span></span>
<span id="cb18-4"><a href="sentiment.html#cb18-4"></a>tweets &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-5"><a href="sentiment.html#cb18-5"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb18-6"><a href="sentiment.html#cb18-6"></a>    <span class="dt">text_clean =</span> <span class="kw">clean_tweet</span>(text))</span>
<span id="cb18-7"><a href="sentiment.html#cb18-7"></a></span>
<span id="cb18-8"><a href="sentiment.html#cb18-8"></a><span class="co"># tweets to words</span></span>
<span id="cb18-9"><a href="sentiment.html#cb18-9"></a>words &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-10"><a href="sentiment.html#cb18-10"></a><span class="st">  </span><span class="kw">select</span>(id, created_at, user_name, text_clean) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-11"><a href="sentiment.html#cb18-11"></a><span class="st">  </span><span class="kw">unnest_tokens</span>(<span class="dt">output =</span> word, <span class="dt">input =</span> text_clean, <span class="dt">token =</span> <span class="st">&quot;words&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-12"><a href="sentiment.html#cb18-12"></a><span class="st">  </span><span class="kw">anti_join</span>(stop_words, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-13"><a href="sentiment.html#cb18-13"></a><span class="st">  </span><span class="kw">left_join</span>(lex_bing, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-14"><a href="sentiment.html#cb18-14"></a><span class="st">  </span><span class="kw">left_join</span>(</span>
<span id="cb18-15"><a href="sentiment.html#cb18-15"></a>    <span class="kw">tribble</span>(</span>
<span id="cb18-16"><a href="sentiment.html#cb18-16"></a>      <span class="op">~</span>sentiment, <span class="op">~</span>lex_score,</span>
<span id="cb18-17"><a href="sentiment.html#cb18-17"></a>      <span class="st">&quot;positive&quot;</span>, <span class="dv">1</span>,</span>
<span id="cb18-18"><a href="sentiment.html#cb18-18"></a>      <span class="st">&quot;negative&quot;</span>, <span class="dv">-1</span>),</span>
<span id="cb18-19"><a href="sentiment.html#cb18-19"></a>    <span class="dt">by =</span> <span class="st">&quot;sentiment&quot;</span>)</span>
<span id="cb18-20"><a href="sentiment.html#cb18-20"></a></span>
<span id="cb18-21"><a href="sentiment.html#cb18-21"></a><span class="co"># tally lex_score per tweet</span></span>
<span id="cb18-22"><a href="sentiment.html#cb18-22"></a>tweets &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-23"><a href="sentiment.html#cb18-23"></a><span class="st">  </span><span class="kw">left_join</span>(</span>
<span id="cb18-24"><a href="sentiment.html#cb18-24"></a>    words <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-25"><a href="sentiment.html#cb18-25"></a><span class="st">      </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-26"><a href="sentiment.html#cb18-26"></a><span class="st">      </span><span class="kw">summarize</span>(</span>
<span id="cb18-27"><a href="sentiment.html#cb18-27"></a>        <span class="dt">lex_score =</span> <span class="kw">mean</span>(lex_score, <span class="dt">na.rm =</span> T)),</span>
<span id="cb18-28"><a href="sentiment.html#cb18-28"></a>    <span class="dt">by =</span> <span class="st">&quot;id&quot;</span>)</span>
<span id="cb18-29"><a href="sentiment.html#cb18-29"></a></span>
<span id="cb18-30"><a href="sentiment.html#cb18-30"></a><span class="co"># tally lex_score per month</span></span>
<span id="cb18-31"><a href="sentiment.html#cb18-31"></a>months &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-32"><a href="sentiment.html#cb18-32"></a><span class="st">  </span><span class="kw">group_by</span>(query_name, ym_date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-33"><a href="sentiment.html#cb18-33"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">lex_score =</span> <span class="kw">mean</span>(lex_score, <span class="dt">na.rm =</span> T))</span>
<span id="cb18-34"><a href="sentiment.html#cb18-34"></a></span>
<span id="cb18-35"><a href="sentiment.html#cb18-35"></a>g &lt;-<span class="st"> </span>months <span class="op">%&gt;%</span></span>
<span id="cb18-36"><a href="sentiment.html#cb18-36"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">query =</span> query_name) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-37"><a href="sentiment.html#cb18-37"></a><span class="st">  </span><span class="kw">ggplot</span>(</span>
<span id="cb18-38"><a href="sentiment.html#cb18-38"></a>    <span class="kw">aes</span>(<span class="dt">x =</span> ym_date, <span class="dt">y =</span> lex_score, <span class="dt">color =</span> query)) <span class="op">+</span></span>
<span id="cb18-39"><a href="sentiment.html#cb18-39"></a><span class="st">  </span><span class="kw">geom_line</span>()</span>
<span id="cb18-40"><a href="sentiment.html#cb18-40"></a><span class="kw">ggplotly</span>(g)</span></code></pre></div>
<div id="htmlwidget-2e2e8a4cf7f135ca86be" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-2e2e8a4cf7f135ca86be">{"x":{"data":[{"x":[17713,17744,17775,17805,17836,17866,17897,17928,17956,17987,18017,18048,18078,18109,18140,18170,18201,18231,18262,18293,18322,18353,18383],"y":[0.333333333333333,null,1,-0.642857142857143,0.181818181818182,-0.5,-0.4,0,-0.184210526315789,-0.378472222222222,-0.5,-0.146825396825397,-0.4,0.293333333333333,-0.144927536231884,-0.262828282828283,-0.285,-0.361538461538462,-0.425925925925926,-0.277777777777778,0.21264367816092,0.302083333333333,-0.5],"text":["ym_date: 2018-07-01<br />lex_score:  0.3333333<br />query: air","ym_date: 2018-08-01<br />lex_score:        NaN<br />query: air","ym_date: 2018-09-01<br />lex_score:  1.0000000<br />query: air","ym_date: 2018-10-01<br />lex_score: -0.6428571<br />query: air","ym_date: 2018-11-01<br />lex_score:  0.1818182<br />query: air","ym_date: 2018-12-01<br />lex_score: -0.5000000<br />query: air","ym_date: 2019-01-01<br />lex_score: -0.4000000<br />query: air","ym_date: 2019-02-01<br />lex_score:  0.0000000<br />query: air","ym_date: 2019-03-01<br />lex_score: -0.1842105<br />query: air","ym_date: 2019-04-01<br />lex_score: -0.3784722<br />query: air","ym_date: 2019-05-01<br />lex_score: -0.5000000<br />query: air","ym_date: 2019-06-01<br />lex_score: -0.1468254<br />query: air","ym_date: 2019-07-01<br />lex_score: -0.4000000<br />query: air","ym_date: 2019-08-01<br />lex_score:  0.2933333<br />query: air","ym_date: 2019-09-01<br />lex_score: -0.1449275<br />query: air","ym_date: 2019-10-01<br />lex_score: -0.2628283<br />query: air","ym_date: 2019-11-01<br />lex_score: -0.2850000<br />query: air","ym_date: 2019-12-01<br />lex_score: -0.3615385<br />query: air","ym_date: 2020-01-01<br />lex_score: -0.4259259<br />query: air","ym_date: 2020-02-01<br />lex_score: -0.2777778<br />query: air","ym_date: 2020-03-01<br />lex_score:  0.2126437<br />query: air","ym_date: 2020-04-01<br />lex_score:  0.3020833<br />query: air","ym_date: 2020-05-01<br />lex_score: -0.5000000<br />query: air"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)","dash":"solid"},"hoveron":"points","name":"air","legendgroup":"air","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[17713,17744,17775,17805,17836,17866,17897,17928,17956,17987,18017,18048,18078,18109,18140,18170,18201,18231,18262,18293,18322,18353,18383],"y":[0.416666666666667,0.666666666666667,0.882352941176471,0.142857142857143,0.384615384615385,0.461538461538462,0.714285714285714,0.875,0.509259259259259,0.4,0.555555555555556,0.69281045751634,0.624183006535948,0.564814814814815,0.698924731182796,0.480874316939891,0.752688172043011,0.638888888888889,0.647342995169082,0.528205128205128,0.518518518518518,0.609756097560976,0.5],"text":["ym_date: 2018-07-01<br />lex_score:  0.4166667<br />query: energy","ym_date: 2018-08-01<br />lex_score:  0.6666667<br />query: energy","ym_date: 2018-09-01<br />lex_score:  0.8823529<br />query: energy","ym_date: 2018-10-01<br />lex_score:  0.1428571<br />query: energy","ym_date: 2018-11-01<br />lex_score:  0.3846154<br />query: energy","ym_date: 2018-12-01<br />lex_score:  0.4615385<br />query: energy","ym_date: 2019-01-01<br />lex_score:  0.7142857<br />query: energy","ym_date: 2019-02-01<br />lex_score:  0.8750000<br />query: energy","ym_date: 2019-03-01<br />lex_score:  0.5092593<br />query: energy","ym_date: 2019-04-01<br />lex_score:  0.4000000<br />query: energy","ym_date: 2019-05-01<br />lex_score:  0.5555556<br />query: energy","ym_date: 2019-06-01<br />lex_score:  0.6928105<br />query: energy","ym_date: 2019-07-01<br />lex_score:  0.6241830<br />query: energy","ym_date: 2019-08-01<br />lex_score:  0.5648148<br />query: energy","ym_date: 2019-09-01<br />lex_score:  0.6989247<br />query: energy","ym_date: 2019-10-01<br />lex_score:  0.4808743<br />query: energy","ym_date: 2019-11-01<br />lex_score:  0.7526882<br />query: energy","ym_date: 2019-12-01<br />lex_score:  0.6388889<br />query: energy","ym_date: 2020-01-01<br />lex_score:  0.6473430<br />query: energy","ym_date: 2020-02-01<br />lex_score:  0.5282051<br />query: energy","ym_date: 2020-03-01<br />lex_score:  0.5185185<br />query: energy","ym_date: 2020-04-01<br />lex_score:  0.6097561<br />query: energy","ym_date: 2020-05-01<br />lex_score:  0.5000000<br />query: energy"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"solid"},"hoveron":"points","name":"energy","legendgroup":"energy","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":40.1826484018265,"l":48.9497716894977},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[17679.5,18416.5],"tickmode":"array","ticktext":["2018-07","2019-01","2019-07","2020-01"],"tickvals":[17713,17897,18078,18262],"categoryorder":"array","categoryarray":["2018-07","2019-01","2019-07","2020-01"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"ym_date","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.725,1.08214285714286],"tickmode":"array","ticktext":["-0.5","0.0","0.5","1.0"],"tickvals":[-0.5,0,0.5,1],"categoryorder":"array","categoryarray":["-0.5","0.0","0.5","1.0"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"lex_score","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"annotations":[{"text":"query","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","showSendToCloud":false},"source":"A","attrs":{"53756756f83b":{"x":{},"y":{},"colour":{},"type":"scatter"}},"cur_data":"53756756f83b","visdat":{"53756756f83b":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="twitter-sentiment140-dataset" class="section level2">
<h2><span class="header-section-number">2.7</span> Twitter Sentiment140 dataset</h2>
<p><a href="http://help.sentiment140.com/for-students">For Academics - Sentiment140 - A Twitter Sentiment Analysis Tool</a></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="sentiment.html#cb19-1"></a><span class="co"># web link to download dataset and folder in which to store</span></span>
<span id="cb19-2"><a href="sentiment.html#cb19-2"></a>s140_url &lt;-<span class="st"> &quot;http://cs.stanford.edu/people/alecmgo/trainingandtestdata.zip&quot;</span></span>
<span id="cb19-3"><a href="sentiment.html#cb19-3"></a>s140_dir &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data/sentiment140&quot;</span>)</span>
<span id="cb19-4"><a href="sentiment.html#cb19-4"></a></span>
<span id="cb19-5"><a href="sentiment.html#cb19-5"></a><span class="co"># download and unzip sentiment140 data</span></span>
<span id="cb19-6"><a href="sentiment.html#cb19-6"></a><span class="cf">if</span> (<span class="kw">length</span>(<span class="kw">list.files</span>(s140_dir)) <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span>){</span>
<span id="cb19-7"><a href="sentiment.html#cb19-7"></a>  s140_zip &lt;-<span class="st"> </span><span class="kw">glue</span>(<span class="st">&quot;{s140_dir}/{basename(s140_url)}&quot;</span>)</span>
<span id="cb19-8"><a href="sentiment.html#cb19-8"></a>  <span class="kw">dir.create</span>(s140_dir, <span class="dt">showWarnings =</span> F)</span>
<span id="cb19-9"><a href="sentiment.html#cb19-9"></a>  <span class="kw">download.file</span>(s140_url, s140_zip)</span>
<span id="cb19-10"><a href="sentiment.html#cb19-10"></a>  <span class="kw">unzip</span>(s140_zip, <span class="dt">exdir =</span> s140_dir)</span>
<span id="cb19-11"><a href="sentiment.html#cb19-11"></a>  <span class="kw">unlink</span>(s140_zip)</span>
<span id="cb19-12"><a href="sentiment.html#cb19-12"></a>}</span>
<span id="cb19-13"><a href="sentiment.html#cb19-13"></a></span>
<span id="cb19-14"><a href="sentiment.html#cb19-14"></a><span class="co"># get training and test files</span></span>
<span id="cb19-15"><a href="sentiment.html#cb19-15"></a>test_csv  &lt;-<span class="st"> </span><span class="kw">list.files</span>(s140_dir, <span class="st">&quot;^test.*&quot;</span>, <span class="dt">full.names =</span> T)</span>
<span id="cb19-16"><a href="sentiment.html#cb19-16"></a></span>
<span id="cb19-17"><a href="sentiment.html#cb19-17"></a><span class="co"># read in testing dataset</span></span>
<span id="cb19-18"><a href="sentiment.html#cb19-18"></a><span class="co"># polarity: convert negative 0 -&gt; -1, neutral 2 -&gt; 0, positive 4 -&gt; 1  </span></span>
<span id="cb19-19"><a href="sentiment.html#cb19-19"></a>s140_cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;polarity&quot;</span>, <span class="st">&quot;id&quot;</span>, <span class="st">&quot;created_at&quot;</span>, <span class="st">&quot;query&quot;</span>, <span class="st">&quot;screen_name&quot;</span>, <span class="st">&quot;text&quot;</span>)</span>
<span id="cb19-20"><a href="sentiment.html#cb19-20"></a>test &lt;-<span class="st"> </span><span class="kw">read_csv</span>(test_csv, <span class="dt">col_names =</span> s140_cols) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-21"><a href="sentiment.html#cb19-21"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb19-22"><a href="sentiment.html#cb19-22"></a>    <span class="dt">polarity   =</span> <span class="kw">recode</span>(polarity, <span class="st">`</span><span class="dt">0</span><span class="st">`</span> =<span class="st"> </span><span class="dv">-1</span>, <span class="st">`</span><span class="dt">2</span><span class="st">`</span> =<span class="st"> </span><span class="dv">0</span>, <span class="st">`</span><span class="dt">4</span><span class="st">`</span> =<span class="st"> </span><span class="dv">1</span>),</span>
<span id="cb19-23"><a href="sentiment.html#cb19-23"></a>    <span class="dt">text_clean =</span> <span class="kw">clean_tweet</span>(text))</span>
<span id="cb19-24"><a href="sentiment.html#cb19-24"></a></span>
<span id="cb19-25"><a href="sentiment.html#cb19-25"></a><span class="co"># test tweets to words</span></span>
<span id="cb19-26"><a href="sentiment.html#cb19-26"></a>test_words &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-27"><a href="sentiment.html#cb19-27"></a><span class="st">  </span><span class="kw">select</span>(id, created_at, screen_name, text_clean) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-28"><a href="sentiment.html#cb19-28"></a><span class="st">  </span><span class="kw">unnest_tokens</span>(<span class="dt">output =</span> word, <span class="dt">input =</span> text_clean, <span class="dt">token =</span> <span class="st">&quot;words&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-29"><a href="sentiment.html#cb19-29"></a><span class="st">  </span><span class="kw">anti_join</span>(stop_words, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-30"><a href="sentiment.html#cb19-30"></a><span class="st">  </span><span class="kw">left_join</span>(lex_bing, <span class="dt">by =</span> <span class="st">&quot;word&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-31"><a href="sentiment.html#cb19-31"></a><span class="st">  </span><span class="kw">left_join</span>(</span>
<span id="cb19-32"><a href="sentiment.html#cb19-32"></a>    <span class="kw">tribble</span>(</span>
<span id="cb19-33"><a href="sentiment.html#cb19-33"></a>      <span class="op">~</span>sentiment, <span class="op">~</span>lex_score,</span>
<span id="cb19-34"><a href="sentiment.html#cb19-34"></a>      <span class="st">&quot;positive&quot;</span>,  <span class="dv">1</span>,</span>
<span id="cb19-35"><a href="sentiment.html#cb19-35"></a>      <span class="st">&quot;negative&quot;</span>, <span class="dv">-1</span>),</span>
<span id="cb19-36"><a href="sentiment.html#cb19-36"></a>    <span class="dt">by =</span> <span class="st">&quot;sentiment&quot;</span>)</span>
<span id="cb19-37"><a href="sentiment.html#cb19-37"></a></span>
<span id="cb19-38"><a href="sentiment.html#cb19-38"></a><span class="co"># tally lex_score per tweet</span></span>
<span id="cb19-39"><a href="sentiment.html#cb19-39"></a>test &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-40"><a href="sentiment.html#cb19-40"></a><span class="st">  </span><span class="kw">left_join</span>(</span>
<span id="cb19-41"><a href="sentiment.html#cb19-41"></a>    test_words <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-42"><a href="sentiment.html#cb19-42"></a><span class="st">      </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-43"><a href="sentiment.html#cb19-43"></a><span class="st">      </span><span class="kw">summarize</span>(</span>
<span id="cb19-44"><a href="sentiment.html#cb19-44"></a>        <span class="dt">lex_score =</span> <span class="kw">mean</span>(lex_score, <span class="dt">na.rm =</span> T)),</span>
<span id="cb19-45"><a href="sentiment.html#cb19-45"></a>    <span class="dt">by =</span> <span class="st">&quot;id&quot;</span>)</span>
<span id="cb19-46"><a href="sentiment.html#cb19-46"></a></span>
<span id="cb19-47"><a href="sentiment.html#cb19-47"></a><span class="kw">hist</span>(test<span class="op">$</span>lex_score)</span></code></pre></div>
<p><img src="MEDS-demo_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="sentiment.html#cb20-1"></a><span class="co"># performance</span></span>
<span id="cb20-2"><a href="sentiment.html#cb20-2"></a>test &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-3"><a href="sentiment.html#cb20-3"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb20-4"><a href="sentiment.html#cb20-4"></a>    <span class="dt">lex_accurate =</span> <span class="kw">case_when</span>(</span>
<span id="cb20-5"><a href="sentiment.html#cb20-5"></a>      polarity <span class="op">==</span><span class="st"> </span><span class="dv">-1</span> <span class="op">&amp;</span><span class="st"> </span>lex_score <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span>T,</span>
<span id="cb20-6"><a href="sentiment.html#cb20-6"></a>      polarity <span class="op">==</span><span class="st">  </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>lex_score <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span>T,</span>
<span id="cb20-7"><a href="sentiment.html#cb20-7"></a>      polarity <span class="op">==</span><span class="st">  </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>lex_score <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> </span>T,</span>
<span id="cb20-8"><a href="sentiment.html#cb20-8"></a>      T <span class="op">~</span><span class="st"> </span>F))</span>
<span id="cb20-9"><a href="sentiment.html#cb20-9"></a><span class="co">#select(test, polarity, lex_score, lex_accurate, text_clean)</span></span>
<span id="cb20-10"><a href="sentiment.html#cb20-10"></a><span class="kw">sum</span>(test<span class="op">$</span>lex_accurate) <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(test)</span></code></pre></div>
<pre><code>## [1] 0.3975904</code></pre>
</div>
<div id="train-tensorflow-model-with-sentiment140" class="section level2">
<h2><span class="header-section-number">2.8</span> Train TensorFlow model with Sentiment140</h2>
<p>Now we’ll train a deep learning model on the Sentiment140 dataset before using to classify the tweets.</p>
<p>This will follow the <a href="https://tensorflow.rstudio.com/tutorials/beginners/basic-ml/tutorial_basic_text_classification/">Text Classification | TensorFlow for R</a> example, except we’ll be using the Sentiment140 dataset from Twitter instead of the IMDB movie review dataset.</p>
<p>The text of the tweets must be converted to tensors before fed into the neural network. First, we create a dictionary and represent each of the 10,000 most common words by an integer. In this case, every tweet will be represented by a sequence of integers.</p>
<p>NOTE: I am unable to knit this Rmarkdown file to html when running tensorflow non-interactively, so the following chunks were run manually in RStudio and set to <code>eval=F</code> to render this web page. Outputs have been roughly replicated below R chunks.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="sentiment.html#cb22-1"></a>train_csv  &lt;-<span class="st"> </span><span class="kw">list.files</span>(s140_dir, <span class="st">&quot;^train.*&quot;</span>, <span class="dt">full.names =</span> T)</span>
<span id="cb22-2"><a href="sentiment.html#cb22-2"></a></span>
<span id="cb22-3"><a href="sentiment.html#cb22-3"></a><span class="co"># load training dataset only if needed since large</span></span>
<span id="cb22-4"><a href="sentiment.html#cb22-4"></a>train &lt;-<span class="st"> </span><span class="kw">read_csv</span>(train_csv, <span class="dt">col_names =</span> s140_cols) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-5"><a href="sentiment.html#cb22-5"></a><span class="kw">mutate</span>(</span>
<span id="cb22-6"><a href="sentiment.html#cb22-6"></a>  <span class="dt">polarity   =</span> <span class="kw">recode</span>(polarity, <span class="st">`</span><span class="dt">0</span><span class="st">`</span> =<span class="st"> </span><span class="dv">-1</span>, <span class="st">`</span><span class="dt">2</span><span class="st">`</span> =<span class="st"> </span><span class="dv">0</span>, <span class="st">`</span><span class="dt">4</span><span class="st">`</span> =<span class="st"> </span><span class="dv">1</span>),</span>
<span id="cb22-7"><a href="sentiment.html#cb22-7"></a>  <span class="dt">text_clean =</span> <span class="kw">clean_tweet</span>(text))</span>
<span id="cb22-8"><a href="sentiment.html#cb22-8"></a></span>
<span id="cb22-9"><a href="sentiment.html#cb22-9"></a><span class="co"># examine labels in training dataset</span></span>
<span id="cb22-10"><a href="sentiment.html#cb22-10"></a>train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(polarity)</span></code></pre></div>
<pre><code># A tibble: 2 x 2
  polarity      n
     &lt;dbl&gt;  &lt;int&gt;
1       -1 800000
2        1 800000</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="sentiment.html#cb24-1"></a><span class="co"># create padded arrays</span></span>
<span id="cb24-2"><a href="sentiment.html#cb24-2"></a>num_words  &lt;-<span class="st"> </span><span class="dv">10000</span></span>
<span id="cb24-3"><a href="sentiment.html#cb24-3"></a>max_length &lt;-<span class="st"> </span><span class="dv">50</span></span>
<span id="cb24-4"><a href="sentiment.html#cb24-4"></a>text_vectorization &lt;-<span class="st"> </span><span class="kw">layer_text_vectorization</span>(</span>
<span id="cb24-5"><a href="sentiment.html#cb24-5"></a>  <span class="dt">max_tokens =</span> num_words, </span>
<span id="cb24-6"><a href="sentiment.html#cb24-6"></a>  <span class="dt">output_sequence_length =</span> max_length)</span>
<span id="cb24-7"><a href="sentiment.html#cb24-7"></a></span>
<span id="cb24-8"><a href="sentiment.html#cb24-8"></a><span class="co"># adapt the text vectorization layer </span></span>
<span id="cb24-9"><a href="sentiment.html#cb24-9"></a><span class="co">#   to learn about unique words in our dataset </span></span>
<span id="cb24-10"><a href="sentiment.html#cb24-10"></a><span class="co">#   and assign an integer value for each one</span></span>
<span id="cb24-11"><a href="sentiment.html#cb24-11"></a>text_vectorization <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb24-12"><a href="sentiment.html#cb24-12"></a><span class="st">  </span><span class="kw">adapt</span>(train<span class="op">$</span>text_clean)</span>
<span id="cb24-13"><a href="sentiment.html#cb24-13"></a></span>
<span id="cb24-14"><a href="sentiment.html#cb24-14"></a><span class="co"># check out the first 20 words</span></span>
<span id="cb24-15"><a href="sentiment.html#cb24-15"></a><span class="kw">get_vocabulary</span>(text_vectorization) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">20</span>)</span></code></pre></div>
<pre><code>usr
i
to
the
a
my
and
you
is
it
for
in
of
im
on
me
so
have
that
but</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="sentiment.html#cb26-1"></a><span class="co"># check out how the text vectorization layer transforms it’s inputs</span></span>
<span id="cb26-2"><a href="sentiment.html#cb26-2"></a><span class="kw">text_vectorization</span>(<span class="kw">matrix</span>(train<span class="op">$</span>text_clean[<span class="dv">1</span>], <span class="dt">ncol =</span> <span class="dv">1</span>))</span></code></pre></div>
<pre><code>tf.Tensor(
[[   2   41  464  105    6 1217    9 3496   51  872    1   14 1875   33
     4   43   11  449    0    0    0    0    0    0    0    0    0    0
     0    0    0    0    0    0    0    0    0    0    0    0    0    0
     0    0    0    0    0    0    0    0]], shape=(1, 50), dtype=int64)</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="sentiment.html#cb28-1"></a><span class="co"># build the model by stacking layers</span></span>
<span id="cb28-2"><a href="sentiment.html#cb28-2"></a>input &lt;-<span class="st"> </span><span class="kw">layer_input</span>(<span class="dt">shape =</span> <span class="kw">c</span>(<span class="dv">1</span>), <span class="dt">dtype =</span> <span class="st">&quot;string&quot;</span>)</span>
<span id="cb28-3"><a href="sentiment.html#cb28-3"></a></span>
<span id="cb28-4"><a href="sentiment.html#cb28-4"></a><span class="co"># input data consists of an array of word-indices</span></span>
<span id="cb28-5"><a href="sentiment.html#cb28-5"></a><span class="co"># labels to predict are either -1 or 1</span></span>
<span id="cb28-6"><a href="sentiment.html#cb28-6"></a>output &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb28-7"><a href="sentiment.html#cb28-7"></a><span class="st">  </span><span class="kw">text_vectorization</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb28-8"><a href="sentiment.html#cb28-8"></a><span class="st">  </span><span class="kw">layer_embedding</span>(<span class="dt">input_dim =</span> num_words <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">output_dim =</span> <span class="dv">16</span>) <span class="op">%&gt;%</span></span>
<span id="cb28-9"><a href="sentiment.html#cb28-9"></a><span class="st">  </span><span class="kw">layer_global_average_pooling_1d</span>() <span class="op">%&gt;%</span></span>
<span id="cb28-10"><a href="sentiment.html#cb28-10"></a><span class="st">  </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">16</span>, <span class="dt">activation =</span> <span class="st">&quot;relu&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb28-11"><a href="sentiment.html#cb28-11"></a><span class="st">  </span><span class="kw">layer_dropout</span>(<span class="fl">0.5</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb28-12"><a href="sentiment.html#cb28-12"></a><span class="st">  </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">1</span>, <span class="dt">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)</span>
<span id="cb28-13"><a href="sentiment.html#cb28-13"></a></span>
<span id="cb28-14"><a href="sentiment.html#cb28-14"></a>model &lt;-<span class="st"> </span><span class="kw">keras_model</span>(input, output)</span>
<span id="cb28-15"><a href="sentiment.html#cb28-15"></a></span>
<span id="cb28-16"><a href="sentiment.html#cb28-16"></a><span class="co"># configure the model to use an optimizer and a loss function</span></span>
<span id="cb28-17"><a href="sentiment.html#cb28-17"></a>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">compile</span>(</span>
<span id="cb28-18"><a href="sentiment.html#cb28-18"></a>  <span class="dt">optimizer =</span> <span class="st">&#39;adam&#39;</span>,</span>
<span id="cb28-19"><a href="sentiment.html#cb28-19"></a>  <span class="dt">loss =</span> <span class="st">&#39;binary_crossentropy&#39;</span>,</span>
<span id="cb28-20"><a href="sentiment.html#cb28-20"></a>  <span class="dt">metrics =</span> <span class="kw">list</span>(<span class="st">&#39;accuracy&#39;</span>))</span>
<span id="cb28-21"><a href="sentiment.html#cb28-21"></a></span>
<span id="cb28-22"><a href="sentiment.html#cb28-22"></a><span class="kw">summary</span>(model)</span></code></pre></div>
<pre><code>Model: &quot;model&quot;
___________________________________________________________
Layer (type)              Output Shape            Param #  
===========================================================
input_1 (InputLayer)      [(None, 1)]             0        
___________________________________________________________
text_vectorization (TextV (None, 50)              0        
___________________________________________________________
embedding (Embedding)     (None, 50, 16)          160016   
___________________________________________________________
global_average_pooling1d  (None, 16)              0        
___________________________________________________________
dense (Dense)             (None, 16)              272      
___________________________________________________________
dropout (Dropout)         (None, 16)              0        
___________________________________________________________
dense_1 (Dense)           (None, 1)               17       
===========================================================
Total params: 160,305
Trainable params: 160,305
Non-trainable params: 0
___________________________________________________________</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="sentiment.html#cb30-1"></a><span class="co"># train the model</span></span>
<span id="cb30-2"><a href="sentiment.html#cb30-2"></a>history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fit</span>(</span>
<span id="cb30-3"><a href="sentiment.html#cb30-3"></a>  train<span class="op">$</span>text_clean,</span>
<span id="cb30-4"><a href="sentiment.html#cb30-4"></a>  <span class="kw">as.numeric</span>(train<span class="op">$</span>polarity <span class="op">==</span><span class="st"> </span><span class="dv">1</span>),</span>
<span id="cb30-5"><a href="sentiment.html#cb30-5"></a>  <span class="dt">epochs =</span> <span class="dv">10</span>,</span>
<span id="cb30-6"><a href="sentiment.html#cb30-6"></a>  <span class="dt">batch_size =</span> <span class="dv">512</span>,</span>
<span id="cb30-7"><a href="sentiment.html#cb30-7"></a>  <span class="dt">validation_split =</span> <span class="fl">0.2</span>,</span>
<span id="cb30-8"><a href="sentiment.html#cb30-8"></a>  <span class="dt">verbose=</span><span class="dv">2</span>)</span></code></pre></div>
<p>RStudio Console output during model fitting:</p>
<pre><code>Epoch 1/10
2500/2500 - 12s - loss: 0.5038 - accuracy: 0.7653
2500/2500 - 14s - loss: 0.5038 - accuracy: 0.7653 - val_loss: 0.6292 - val_accuracy: 0.6683
Epoch 2/10
2500/2500 - 12s - loss: 0.4460 - accuracy: 0.8008
2500/2500 - 14s - loss: 0.4460 - accuracy: 0.8008 - val_loss: 0.6068 - val_accuracy: 0.6683
Epoch 3/10
2500/2500 - 12s - loss: 0.4362 - accuracy: 0.8052
2500/2500 - 13s - loss: 0.4362 - accuracy: 0.8052 - val_loss: 0.5989 - val_accuracy: 0.6673
Epoch 4/10
2500/2500 - 12s - loss: 0.4331 - accuracy: 0.8052
2500/2500 - 14s - loss: 0.4331 - accuracy: 0.8052 - val_loss: 0.6402 - val_accuracy: 0.6384
Epoch 5/10
2500/2500 - 12s - loss: 0.4316 - accuracy: 0.8057
2500/2500 - 14s - loss: 0.4316 - accuracy: 0.8057 - val_loss: 0.6075 - val_accuracy: 0.6595
Epoch 6/10
2500/2500 - 12s - loss: 0.4300 - accuracy: 0.8055
2500/2500 - 14s - loss: 0.4300 - accuracy: 0.8055 - val_loss: 0.6324 - val_accuracy: 0.6413
Epoch 7/10
2500/2500 - 12s - loss: 0.4288 - accuracy: 0.8061
2500/2500 - 14s - loss: 0.4288 - accuracy: 0.8061 - val_loss: 0.6453 - val_accuracy: 0.6341
Epoch 8/10
2500/2500 - 12s - loss: 0.4279 - accuracy: 0.8063
2500/2500 - 13s - loss: 0.4279 - accuracy: 0.8063 - val_loss: 0.5983 - val_accuracy: 0.6701
Epoch 9/10
2500/2500 - 12s - loss: 0.4273 - accuracy: 0.8071
2500/2500 - 14s - loss: 0.4273 - accuracy: 0.8071 - val_loss: 0.5900 - val_accuracy: 0.6770
Epoch 10/10
2500/2500 - 12s - loss: 0.4260 - accuracy: 0.8070
2500/2500 - 14s - loss: 0.4260 - accuracy: 0.8070 - val_loss: 0.6074 - val_accuracy: 0.6700</code></pre>
<p>RStudio Viewer output during model fitting:</p>
<p><img src="images/tf_model_fit.png" /></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="sentiment.html#cb32-1"></a><span class="co"># model accuracy and loss over iterations</span></span>
<span id="cb32-2"><a href="sentiment.html#cb32-2"></a><span class="kw">plot</span>(history)</span></code></pre></div>
<p><img src="images/tf_model_history.png" /></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="sentiment.html#cb33-1"></a><span class="co"># evaluate the model</span></span>
<span id="cb33-2"><a href="sentiment.html#cb33-2"></a>tf_score &lt;-<span class="st"> </span><span class="kw">predict</span>(model, test<span class="op">$</span>text_clean)[,<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-3"><a href="sentiment.html#cb33-3"></a><span class="st">  </span><span class="kw">rescale</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb33-4"><a href="sentiment.html#cb33-4"></a></span>
<span id="cb33-5"><a href="sentiment.html#cb33-5"></a><span class="co"># performance</span></span>
<span id="cb33-6"><a href="sentiment.html#cb33-6"></a>test &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-7"><a href="sentiment.html#cb33-7"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb33-8"><a href="sentiment.html#cb33-8"></a>    <span class="dt">tf_score =</span> tf_score,</span>
<span id="cb33-9"><a href="sentiment.html#cb33-9"></a>    <span class="dt">tf_accurate =</span> <span class="kw">case_when</span>(</span>
<span id="cb33-10"><a href="sentiment.html#cb33-10"></a>      polarity <span class="op">==</span><span class="st"> </span><span class="dv">-1</span> <span class="op">&amp;</span><span class="st"> </span>tf_score <span class="op">&lt;</span><span class="st"> </span><span class="fl">-0.1</span> <span class="op">~</span><span class="st"> </span>T,</span>
<span id="cb33-11"><a href="sentiment.html#cb33-11"></a>      polarity <span class="op">==</span><span class="st">  </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>tf_score <span class="op">&gt;</span><span class="st"> </span><span class="fl">-0.1</span> <span class="op">&amp;</span><span class="st"> </span>tf_score <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.1</span> <span class="op">~</span><span class="st"> </span>T,</span>
<span id="cb33-12"><a href="sentiment.html#cb33-12"></a>      polarity <span class="op">==</span><span class="st">  </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>tf_score <span class="op">&gt;</span><span class="st">  </span><span class="fl">0.1</span> <span class="op">~</span><span class="st"> </span>T,</span>
<span id="cb33-13"><a href="sentiment.html#cb33-13"></a>      T <span class="op">~</span><span class="st"> </span>F))</span>
<span id="cb33-14"><a href="sentiment.html#cb33-14"></a></span>
<span id="cb33-15"><a href="sentiment.html#cb33-15"></a><span class="co">#select(test, polarity, tf_score, tf_accurate, text_clean)</span></span>
<span id="cb33-16"><a href="sentiment.html#cb33-16"></a><span class="kw">sum</span>(test<span class="op">$</span>tf_accurate) <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(test)</span></code></pre></div>
<pre><code>[1] 0.5763052</code></pre>
</div>
<div id="classify-sentiment-of-tweets-over-time-using-tensorflow" class="section level2">
<h2><span class="header-section-number">2.9</span> Classify sentiment of tweets over time, using TensorFlow</h2>
<p>Now that we’ve trained the TensorFlow model, we can classify the tweets using this model.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="sentiment.html#cb35-1"></a>sentiments_csv &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="kw">glue</span>(<span class="st">&quot;data/sentiments_{loc_name}.csv&quot;</span>))</span>
<span id="cb35-2"><a href="sentiment.html#cb35-2"></a></span>
<span id="cb35-3"><a href="sentiment.html#cb35-3"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(sentiments_csv)){</span>
<span id="cb35-4"><a href="sentiment.html#cb35-4"></a></span>
<span id="cb35-5"><a href="sentiment.html#cb35-5"></a>  <span class="co"># predict with model</span></span>
<span id="cb35-6"><a href="sentiment.html#cb35-6"></a>  tweets &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-7"><a href="sentiment.html#cb35-7"></a><span class="st">    </span><span class="kw">mutate</span>(</span>
<span id="cb35-8"><a href="sentiment.html#cb35-8"></a>      <span class="dt">tf_score =</span> <span class="kw">predict</span>(model, tweets<span class="op">$</span>text_clean)[,<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-9"><a href="sentiment.html#cb35-9"></a><span class="st">        </span><span class="kw">rescale</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb35-10"><a href="sentiment.html#cb35-10"></a>  </span>
<span id="cb35-11"><a href="sentiment.html#cb35-11"></a>  <span class="co"># tally score per month</span></span>
<span id="cb35-12"><a href="sentiment.html#cb35-12"></a>  months &lt;-<span class="st"> </span>tweets <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-13"><a href="sentiment.html#cb35-13"></a><span class="st">    </span><span class="kw">group_by</span>(query_name, ym_date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-14"><a href="sentiment.html#cb35-14"></a><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">tf_score =</span> <span class="kw">mean</span>(tf_score, <span class="dt">na.rm =</span> T))</span>
<span id="cb35-15"><a href="sentiment.html#cb35-15"></a>  </span>
<span id="cb35-16"><a href="sentiment.html#cb35-16"></a>  <span class="co"># save monthly results</span></span>
<span id="cb35-17"><a href="sentiment.html#cb35-17"></a>  <span class="kw">write_csv</span>(months, sentiments_csv)</span>
<span id="cb35-18"><a href="sentiment.html#cb35-18"></a>}</span>
<span id="cb35-19"><a href="sentiment.html#cb35-19"></a>months &lt;-<span class="st"> </span><span class="kw">read_csv</span>(sentiments_csv)</span>
<span id="cb35-20"><a href="sentiment.html#cb35-20"></a></span>
<span id="cb35-21"><a href="sentiment.html#cb35-21"></a>g &lt;-<span class="st"> </span>months <span class="op">%&gt;%</span></span>
<span id="cb35-22"><a href="sentiment.html#cb35-22"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">query =</span> query_name) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-23"><a href="sentiment.html#cb35-23"></a><span class="st">  </span><span class="kw">ggplot</span>(</span>
<span id="cb35-24"><a href="sentiment.html#cb35-24"></a>    <span class="kw">aes</span>(<span class="dt">x =</span> ym_date, <span class="dt">y =</span> tf_score, <span class="dt">color =</span> query)) <span class="op">+</span></span>
<span id="cb35-25"><a href="sentiment.html#cb35-25"></a><span class="st">  </span><span class="kw">geom_line</span>()</span>
<span id="cb35-26"><a href="sentiment.html#cb35-26"></a><span class="kw">ggplotly</span>(g)</span></code></pre></div>
<div id="htmlwidget-29b67d5c55c1203a33e5" style="width:672px;height:480px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-29b67d5c55c1203a33e5">{"x":{"data":[{"x":[17713,17744,17775,17805,17836,17866,17897,17928,17956,17987,18017,18048,18078,18109,18140,18170,18201,18231,18262,18293,18322,18353,18383],"y":[0.143818542263391,-0.370192230155174,0.109500728015067,-0.426510039237821,0.0895903443734834,0.0127403530840106,-0.081174638492464,-0.0826691208837776,0.128877017913877,-0.00984876886737584,0.0792530990363125,0.135269996178338,0.187496696995097,0.120446772639728,0.129175534374361,0.0641345265360119,0.00576913190288732,-0.101243614557159,0.0221781511640218,0.118034731772033,0.151043494669337,0.0856455279634269,0.160198204839354],"text":["ym_date: 2018-07-01<br />tf_score:  0.143818542<br />query: air","ym_date: 2018-08-01<br />tf_score: -0.370192230<br />query: air","ym_date: 2018-09-01<br />tf_score:  0.109500728<br />query: air","ym_date: 2018-10-01<br />tf_score: -0.426510039<br />query: air","ym_date: 2018-11-01<br />tf_score:  0.089590344<br />query: air","ym_date: 2018-12-01<br />tf_score:  0.012740353<br />query: air","ym_date: 2019-01-01<br />tf_score: -0.081174638<br />query: air","ym_date: 2019-02-01<br />tf_score: -0.082669121<br />query: air","ym_date: 2019-03-01<br />tf_score:  0.128877018<br />query: air","ym_date: 2019-04-01<br />tf_score: -0.009848769<br />query: air","ym_date: 2019-05-01<br />tf_score:  0.079253099<br />query: air","ym_date: 2019-06-01<br />tf_score:  0.135269996<br />query: air","ym_date: 2019-07-01<br />tf_score:  0.187496697<br />query: air","ym_date: 2019-08-01<br />tf_score:  0.120446773<br />query: air","ym_date: 2019-09-01<br />tf_score:  0.129175534<br />query: air","ym_date: 2019-10-01<br />tf_score:  0.064134527<br />query: air","ym_date: 2019-11-01<br />tf_score:  0.005769132<br />query: air","ym_date: 2019-12-01<br />tf_score: -0.101243615<br />query: air","ym_date: 2020-01-01<br />tf_score:  0.022178151<br />query: air","ym_date: 2020-02-01<br />tf_score:  0.118034732<br />query: air","ym_date: 2020-03-01<br />tf_score:  0.151043495<br />query: air","ym_date: 2020-04-01<br />tf_score:  0.085645528<br />query: air","ym_date: 2020-05-01<br />tf_score:  0.160198205<br />query: air"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)","dash":"solid"},"hoveron":"points","name":"air","legendgroup":"air","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[17713,17744,17775,17805,17836,17866,17897,17928,17956,17987,18017,18048,18078,18109,18140,18170,18201,18231,18262,18293,18322,18353,18383],"y":[0.151946610480806,0.477863419562196,0.429492217951651,0.427899854102663,0.628165019711713,0.4253281451794,0.527221779339894,0.686598519636664,0.325232802832459,0.317191074189087,0.423489928917659,0.486949445832487,0.424042964047601,0.425710482649117,0.554230052018449,0.361139610058805,0.454541653355073,0.376677882744346,0.445559195824472,0.352402487019224,0.38368067435715,0.35334110913585,0.402401649492642],"text":["ym_date: 2018-07-01<br />tf_score:  0.151946610<br />query: energy","ym_date: 2018-08-01<br />tf_score:  0.477863420<br />query: energy","ym_date: 2018-09-01<br />tf_score:  0.429492218<br />query: energy","ym_date: 2018-10-01<br />tf_score:  0.427899854<br />query: energy","ym_date: 2018-11-01<br />tf_score:  0.628165020<br />query: energy","ym_date: 2018-12-01<br />tf_score:  0.425328145<br />query: energy","ym_date: 2019-01-01<br />tf_score:  0.527221779<br />query: energy","ym_date: 2019-02-01<br />tf_score:  0.686598520<br />query: energy","ym_date: 2019-03-01<br />tf_score:  0.325232803<br />query: energy","ym_date: 2019-04-01<br />tf_score:  0.317191074<br />query: energy","ym_date: 2019-05-01<br />tf_score:  0.423489929<br />query: energy","ym_date: 2019-06-01<br />tf_score:  0.486949446<br />query: energy","ym_date: 2019-07-01<br />tf_score:  0.424042964<br />query: energy","ym_date: 2019-08-01<br />tf_score:  0.425710483<br />query: energy","ym_date: 2019-09-01<br />tf_score:  0.554230052<br />query: energy","ym_date: 2019-10-01<br />tf_score:  0.361139610<br />query: energy","ym_date: 2019-11-01<br />tf_score:  0.454541653<br />query: energy","ym_date: 2019-12-01<br />tf_score:  0.376677883<br />query: energy","ym_date: 2020-01-01<br />tf_score:  0.445559196<br />query: energy","ym_date: 2020-02-01<br />tf_score:  0.352402487<br />query: energy","ym_date: 2020-03-01<br />tf_score:  0.383680674<br />query: energy","ym_date: 2020-04-01<br />tf_score:  0.353341109<br />query: energy","ym_date: 2020-05-01<br />tf_score:  0.402401649<br />query: energy"],"type":"scatter","mode":"lines","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)","dash":"solid"},"hoveron":"points","name":"energy","legendgroup":"energy","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":26.2283105022831,"r":7.30593607305936,"b":40.1826484018265,"l":54.7945205479452},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[17679.5,18416.5],"tickmode":"array","ticktext":["2018-07","2019-01","2019-07","2020-01"],"tickvals":[17713,17897,18078,18262],"categoryorder":"array","categoryarray":["2018-07","2019-01","2019-07","2020-01"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"ym_date","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.482165467181545,0.742253947580388],"tickmode":"array","ticktext":["-0.25","0.00","0.25","0.50"],"tickvals":[-0.25,0,0.25,0.5],"categoryorder":"array","categoryarray":["-0.25","0.00","0.25","0.50"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"tf_score","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"annotations":[{"text":"query","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","showSendToCloud":false},"source":"A","attrs":{"53755a4f648b":{"x":{},"y":{},"colour":{},"type":"scatter"}},"cur_data":"53755a4f648b","visdat":{"53755a4f648b":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-gurajalaUnderstandingPublicResponse2019">
<p>Gurajala, Supraja, Suresh Dhaniyala, and Jeanna N. Matthews. 2019. “Understanding Public Response to Air Quality Using Tweet Analysis.” <em>Social Media + Society</em> 5 (3): 2056305119867656. <a href="https://doi.org/10.1177/2056305119867656">https://doi.org/10.1177/2056305119867656</a>.</p>
</div>
<div id="ref-slubanSentimentLeaningInfluential2015">
<p>Sluban, Borut, Jasmina Smailović, Stefano Battiston, and Igor Mozetič. 2015. “Sentiment Leaning of Influential Communities in Social Networks.” <em>Compu Social Networls</em> 2 (1): 9. <a href="https://doi.org/10.1186/s40649-015-0016-5">https://doi.org/10.1186/s40649-015-0016-5</a>.</p>
</div>
</div>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/lesson.js"></script>
            </section>

          </div>
        </div>
      </div>
<a href="satellite.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="integration.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ecoquants/r3-workshop/blob/master/02_sentiment.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["MEDS-demo.pdf"],
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

</body>

</html>
